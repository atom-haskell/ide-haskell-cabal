"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
function unindentMessage(lines) {
    const minIndent = Math.min(...lines.map((line) => {
        const match = line.match(/^\s*/);
        if (match) {
            return match[0].length;
        }
        else {
            return 0;
        }
    }));
    return lines.map((line) => line.slice(minIndent)).join('\n');
}
function parseMessage(raw, cwd, defaultSeverity) {
    if (raw.trim() !== '') {
        const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
        const matched = raw.trimRight().match(matchLoc);
        if (matched) {
            const [file, line, col, rawTyp, context, msg] = matched.slice(1);
            const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
            return [
                true,
                {
                    uri: path.isAbsolute(file) ? file : cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell',
                    },
                    severity: typ,
                },
            ];
        }
        else {
            return [
                false,
                {
                    message: raw,
                    severity: defaultSeverity,
                },
            ];
        }
    }
    return [false, undefined];
}
function runBuilderProcess(command, args, options, params) {
    const cwd = new atom_1.Directory(options.cwd || '.');
    let hasError = false;
    let severity = params.severity;
    const proc = child_process.spawn(command, args, options);
    proc.on('error', function (err) {
        atom.notifications.addError(err.name, {
            detail: err.message,
            dismissable: true,
        });
    });
    const buffered = (handleOutput) => {
        let buffer = '';
        return (data) => {
            const output = data.toString('utf8');
            const [first, ...tail] = output.split(os_1.EOL);
            buffer += first;
            if (tail.length > 0) {
                const lines = [buffer, ...tail.slice(0, -1)];
                buffer = tail.slice(-1)[0];
                handleOutput(lines);
            }
        };
    };
    const blockBuffered = (handleOutput) => {
        const startOfMessage = /\n(?=\S)(?!\d+ \|)/g;
        let buffer = [];
        proc.on('close', () => handleOutput(buffer.join('\n')));
        return buffered((lines) => {
            buffer.push(...lines);
            const [first, ...tail] = buffer.join('\n').split(startOfMessage);
            if (tail.length > 0) {
                const last = tail.slice(-1)[0];
                buffer = last.split('\n');
                for (const block of [first, ...tail.slice(0, -1)]) {
                    handleOutput(block);
                }
            }
        });
    };
    if (params.setCancelAction) {
        params.setCancelAction(() => {
            try {
                process_1.kill(-proc.pid);
            }
            catch (e) {
            }
            try {
                process_1.kill(proc.pid);
            }
            catch (e) {
            }
            try {
                proc.kill();
            }
            catch (e) {
            }
        });
    }
    const handleMessage = (msg) => {
        if (params.onProgress) {
            const match = msg.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
            if (match) {
                const progress = match[1];
                const total = match[2];
                params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
            }
        }
        if (params.severityChangeRx) {
            for (const [sev, rx] of Object.entries(params.severityChangeRx)) {
                if (msg.match(rx)) {
                    severity = sev;
                    break;
                }
            }
        }
        let parsed;
        [hasError, parsed] = parseMessage(msg, cwd, severity);
        if (parsed && params.onMsg)
            params.onMsg(parsed);
    };
    proc.stdout.on('data', blockBuffered(handleMessage));
    proc.stderr.on('data', blockBuffered(handleMessage));
    proc.on('close', (exitCode) => {
        if (params.onDone) {
            params.onDone({ exitCode, hasError: hasError });
        }
    });
}
async function runProcess(command, args, options, pars) {
    let interval = undefined;
    try {
        interval = window.setInterval(() => process.activateUvLoop(), 100);
        return await new Promise((resolve) => {
            const newPars = Object.assign(Object.assign({}, pars), { onDone: resolve });
            runBuilderProcess(command, args, options, newPars);
        });
    }
    finally {
        if (interval !== undefined)
            window.clearInterval(interval);
    }
}
exports.runProcess = runProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9idWlsZGVycy9iYXNlL3Byb2Nlc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQ0FBOEM7QUFDOUMscUNBQThCO0FBQzlCLDZCQUE0QjtBQUM1QiwyQkFBd0I7QUFJeEIsK0JBQXVDO0FBYXZDLFNBQVMsZUFBZSxDQUFDLEtBQWU7SUFDdEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FDeEIsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDcEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNoQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtTQUN2QjthQUFNO1lBQ0wsT0FBTyxDQUFDLENBQUE7U0FDVDtJQUNILENBQUMsQ0FBQyxDQUNILENBQUE7SUFDRCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDOUQsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUNuQixHQUFXLEVBQ1gsR0FBYyxFQUNkLGVBQThCO0lBRTlCLElBQUksR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNyQixNQUFNLFFBQVEsR0FBRyxrRUFBa0UsQ0FBQTtRQUNuRixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQy9DLElBQUksT0FBTyxFQUFFO1lBQ1gsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUs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Y2VzcydcbmltcG9ydCB7IGtpbGwgfSBmcm9tICdwcm9jZXNzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcblxuLy8gLy8gQXRvbSBkZXBlbmRlbmNpZXNcbmltcG9ydCB7IERpcmVjdG9yeSwgUG9pbnQgfSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgdHlwZSBJUGFyYW1zID0gT21pdDxJUGFyYW1zSW50ZXJuYWwsICdvbkRvbmUnPlxuXG5pbnRlcmZhY2UgSVBhcmFtc0ludGVybmFsIHtcbiAgcmVhZG9ubHkgb25Nc2c/OiAobXNnOiBVUEkuSVJlc3VsdEl0ZW0pID0+IHZvaWRcbiAgcmVhZG9ubHkgb25Qcm9ncmVzcz86IChwcm9ncmVzczogbnVtYmVyKSA9PiB2b2lkXG4gIHJlYWRvbmx5IG9uRG9uZT86IChkb25lOiB7IGV4aXRDb2RlOiBudW1iZXI7IGhhc0Vycm9yOiBib29sZWFuIH0pID0+IHZvaWRcbiAgcmVhZG9ubHkgc2V0Q2FuY2VsQWN0aW9uPzogKGFjdGlvbjogKCkgPT4gdm9pZCkgPT4gdm9pZFxuICByZWFkb25seSBzZXZlcml0eTogVVBJLlRTZXZlcml0eVxuICByZWFkb25seSBzZXZlcml0eUNoYW5nZVJ4PzogeyBbSyBpbiBVUEkuVFNldmVyaXR5XTogUmVnRXhwIH1cbn1cblxuZnVuY3Rpb24gdW5pbmRlbnRNZXNzYWdlKGxpbmVzOiBzdHJpbmdbXSkge1xuICBjb25zdCBtaW5JbmRlbnQgPSBNYXRoLm1pbihcbiAgICAuLi5saW5lcy5tYXAoKGxpbmUpID0+IHtcbiAgICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCgvXlxccyovKVxuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIHJldHVybiBtYXRjaFswXS5sZW5ndGhcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwXG4gICAgICB9XG4gICAgfSksXG4gIClcbiAgcmV0dXJuIGxpbmVzLm1hcCgobGluZSkgPT4gbGluZS5zbGljZShtaW5JbmRlbnQpKS5qb2luKCdcXG4nKVxufVxuXG5mdW5jdGlvbiBwYXJzZU1lc3NhZ2UoXG4gIHJhdzogc3RyaW5nLFxuICBjd2Q6IERpcmVjdG9yeSxcbiAgZGVmYXVsdFNldmVyaXR5OiBVUEkuVFNldmVyaXR5LFxuKTogW2Jvb2xlYW4sIFVQSS5JUmVzdWx0SXRlbT9dIHtcbiAgaWYgKHJhdy50cmltKCkgIT09ICcnKSB7XG4gICAgY29uc3QgbWF0Y2hMb2MgPSAvXiguKyk6KFxcZCspOihcXGQrKTooPzogKFxcdyspOik/WyBcXHRdKihcXFtbXlxcXV0rXFxdKT9bIFxcdF0qXFxuPyhbXl0qKS9cbiAgICBjb25zdCBtYXRjaGVkID0gcmF3LnRyaW1SaWdodCgpLm1hdGNoKG1hdGNoTG9jKVxuICAgIGlmIChtYXRjaGVkKSB7XG4gICAgICBjb25zdCBbZmlsZSwgbGluZSwgY29sLCByYXdUeXAsIGNvbnRleHQsIG1zZ10gPSBtYXRjaGVkLnNsaWNlKDEpXG4gICAgICBjb25zdCB0eXAgPSByYXdUeXAgPyByYXdUeXAudG9Mb3dlckNhc2UoKSA6ICdlcnJvcidcblxuICAgICAgcmV0dXJuIFtcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAge1xuICAgICAgICAgIHVyaTogcGF0aC5pc0Fic29sdXRlKGZpbGUpID8gZmlsZSA6IGN3ZC5nZXRGaWxlKGZpbGUpLmdldFBhdGgoKSxcbiAgICAgICAgICBwb3NpdGlvbjogbmV3IFBvaW50KHBhcnNlSW50KGxpbmUsIDEwKSAtIDEsIHBhcnNlSW50KGNvbCwgMTApIC0gMSksXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICB0ZXh0OiB1bmluZGVudE1lc3NhZ2UobXNnLnNwbGl0KCdcXG4nKSksXG4gICAgICAgICAgICBoaWdobGlnaHRlcjogJ2hpbnQubWVzc2FnZS5oYXNrZWxsJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNldmVyaXR5OiB0eXAsXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIGZhbHNlLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogcmF3LFxuICAgICAgICAgIHNldmVyaXR5OiBkZWZhdWx0U2V2ZXJpdHksXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgfVxuICB9XG4gIHJldHVybiBbZmFsc2UsIHVuZGVmaW5lZF1cbn1cblxuZnVuY3Rpb24gcnVuQnVpbGRlclByb2Nlc3MoXG4gIGNvbW1hbmQ6IHN0cmluZyxcbiAgYXJnczogc3RyaW5nW10sXG4gIG9wdGlvbnM6IGNoaWxkX3Byb2Nlc3MuU3Bhd25PcHRpb25zLFxuICBwYXJhbXM6IElQYXJhbXNJbnRlcm5hbCxcbikge1xuICBjb25zdCBjd2QgPSBuZXcgRGlyZWN0b3J5KG9wdGlvbnMuY3dkIHx8ICcuJylcbiAgLy8gY2FiYWwgcmV0dXJucyBmYWlsdXJlIHdoZW4gdGhlcmUgYXJlIHR5cGUgZXJyb3JzIF9vcl8gd2hlbiBpdCBjYW4ndFxuICAvLyBjb21waWxlIHRoZSBjb2RlIGF0IGFsbCAoaS5lLiwgd2hlbiB0aGVyZSBhcmUgbWlzc2luZyBkZXBlbmRlbmNpZXMpLlxuICAvLyBTaW5jZSBpdCdzIGhhcmQgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiB0aGVzZSB0d28sIHdlIGxvb2sgYXQgdGhlXG4gIC8vIHBhcnNlZCBlcnJvcnM7XG4gIC8vIHRoaXMuaGFzRXJyb3IgaXMgc2V0IGlmIHdlIGZpbmQgYW4gZXJyb3Ivd2FybmluZywgc2VlIHBhcnNlTWVzc2FnZVxuICBsZXQgaGFzRXJyb3IgPSBmYWxzZVxuICBsZXQgc2V2ZXJpdHk6IFVQSS5UU2V2ZXJpdHkgPSBwYXJhbXMuc2V2ZXJpdHlcbiAgY29uc3QgcHJvYyA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oY29tbWFuZCwgYXJncywgb3B0aW9ucylcbiAgcHJvYy5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyLm5hbWUsIHtcbiAgICAgIGRldGFpbDogZXJyLm1lc3NhZ2UsXG4gICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICB9KVxuICB9KVxuXG4gIGNvbnN0IGJ1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGxpbmVzOiBzdHJpbmdbXSkgPT4gdm9pZCkgPT4ge1xuICAgIGxldCBidWZmZXIgPSAnJ1xuICAgIHJldHVybiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXQgPSBkYXRhLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgIGNvbnN0IFtmaXJzdCwgLi4udGFpbF0gPSBvdXRwdXQuc3BsaXQoRU9MKVxuICAgICAgLy8gXiBUaGUgb25seSBwbGFjZSB3aGVyZSB3ZSBnZXQgb3Mtc3BlY2lmaWMgRU9MIChDUi9DUkxGL0xGKVxuICAgICAgLy8gaW4gdGhlIHJlc3Qgb2YgdGhlIGNvZGUgd2UncmUgdXNpbmcganVzdCBMRiAoXFxuKVxuICAgICAgYnVmZmVyICs9IGZpcnN0XG4gICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIGl0IG1lYW5zIHRoZXJlJ3MgYXQgbGVhc3Qgb25lIG5ld2xpbmVcbiAgICAgICAgY29uc3QgbGluZXMgPSBbYnVmZmVyLCAuLi50YWlsLnNsaWNlKDAsIC0xKV1cbiAgICAgICAgYnVmZmVyID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgaGFuZGxlT3V0cHV0KGxpbmVzKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGJsb2NrQnVmZmVyZWQgPSAoaGFuZGxlT3V0cHV0OiAoYmxvY2s6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICAgIC8vIFN0YXJ0IG9mIGEgQ2FiYWwgbWVzc2FnZVxuICAgIGNvbnN0IHN0YXJ0T2ZNZXNzYWdlID0gL1xcbig/PVxcUykoPyFcXGQrIFxcfCkvZ1xuICAgIGxldCBidWZmZXI6IHN0cmluZ1tdID0gW11cbiAgICBwcm9jLm9uKCdjbG9zZScsICgpID0+IGhhbmRsZU91dHB1dChidWZmZXIuam9pbignXFxuJykpKVxuICAgIHJldHVybiBidWZmZXJlZCgobGluZXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICBidWZmZXIucHVzaCguLi5saW5lcylcbiAgICAgIC8vIENvdWxkIGl0ZXJhdGUgb3ZlciBsaW5lcyBoZXJlLCBidXQgdGhpcyBpcyBlYXNpZXIsIGlmIG5vdCBhcyBlZmZlY3RpdmVcbiAgICAgIGNvbnN0IFtmaXJzdCwgLi4udGFpbF0gPSBidWZmZXIuam9pbignXFxuJykuc3BsaXQoc3RhcnRPZk1lc3NhZ2UpXG4gICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGxhc3QgPSB0YWlsLnNsaWNlKC0xKVswXVxuICAgICAgICBidWZmZXIgPSBsYXN0LnNwbGl0KCdcXG4nKVxuICAgICAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIFtmaXJzdCwgLi4udGFpbC5zbGljZSgwLCAtMSldKSB7XG4gICAgICAgICAgaGFuZGxlT3V0cHV0KGJsb2NrKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGlmIChwYXJhbXMuc2V0Q2FuY2VsQWN0aW9uKSB7XG4gICAgcGFyYW1zLnNldENhbmNlbEFjdGlvbigoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBraWxsKC1wcm9jLnBpZClcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLypub29wKi9cbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGtpbGwocHJvYy5waWQpXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8qbm9vcCovXG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBwcm9jLmtpbGwoKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvKm5vb3AqL1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBjb25zdCBoYW5kbGVNZXNzYWdlID0gKG1zZzogc3RyaW5nKSA9PiB7XG4gICAgaWYgKHBhcmFtcy5vblByb2dyZXNzKSB7XG4gICAgICAvLyBjaGVjayBwcm9ncmVzc1xuICAgICAgY29uc3QgbWF0Y2ggPSBtc2cubWF0Y2goL1xcW1xccyooW1xcZF0rKVxccytvZlxccysoW1xcZF0rKVxccypcXF0vKVxuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gbWF0Y2hbMV1cbiAgICAgICAgY29uc3QgdG90YWwgPSBtYXRjaFsyXVxuICAgICAgICBwYXJhbXMub25Qcm9ncmVzcyhwYXJzZUludChwcm9ncmVzcywgMTApIC8gcGFyc2VJbnQodG90YWwsIDEwKSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSB7XG4gICAgICAvLyBjaGVjayBzZXZlcml0eSBjaGFuZ2VcbiAgICAgIGZvciAoY29uc3QgW3NldiwgcnhdIG9mIE9iamVjdC5lbnRyaWVzKHBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSkge1xuICAgICAgICBpZiAobXNnLm1hdGNoKHJ4KSkge1xuICAgICAgICAgIHNldmVyaXR5ID0gc2V2XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBsZXQgcGFyc2VkOiBVUEkuSVJlc3VsdEl0ZW0gfCB1bmRlZmluZWRcbiAgICA7W2hhc0Vycm9yLCBwYXJzZWRdID0gcGFyc2VNZXNzYWdlKG1zZywgY3dkLCBzZXZlcml0eSlcbiAgICBpZiAocGFyc2VkICYmIHBhcmFtcy5vbk1zZykgcGFyYW1zLm9uTXNnKHBhcnNlZClcbiAgfVxuXG4gIC8vIE5vdGU6IGJsb2NrQnVmZmVyZWQgdXNlZCB0d2ljZSBiZWNhdXNlIHdlIG5lZWQgc2VwYXJhdGUgYnVmZmVyc1xuICAvLyBmb3Igc3RkZXJyIGFuZCBzdGRvdXRcbiAgcHJvYy5zdGRvdXQub24oJ2RhdGEnLCBibG9ja0J1ZmZlcmVkKGhhbmRsZU1lc3NhZ2UpKVxuICBwcm9jLnN0ZGVyci5vbignZGF0YScsIGJsb2NrQnVmZmVyZWQoaGFuZGxlTWVzc2FnZSkpXG5cbiAgcHJvYy5vbignY2xvc2UnLCAoZXhpdENvZGUpID0+IHtcbiAgICBpZiAocGFyYW1zLm9uRG9uZSkge1xuICAgICAgcGFyYW1zLm9uRG9uZSh7IGV4aXRDb2RlLCBoYXNFcnJvcjogaGFzRXJyb3IgfSlcbiAgICB9XG4gIH0pXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5Qcm9jZXNzKFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIGFyZ3M6IHN0cmluZ1tdLFxuICBvcHRpb25zOiBjaGlsZF9wcm9jZXNzLlNwYXduT3B0aW9ucyxcbiAgcGFyczogSVBhcmFtcyxcbikge1xuICBsZXQgaW50ZXJ2YWw6IG51bWJlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuICB0cnkge1xuICAgIGludGVydmFsID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHByb2Nlc3MuYWN0aXZhdGVVdkxvb3AoKSwgMTAwKVxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTx7IGV4aXRDb2RlOiBudW1iZXI7IGhhc0Vycm9yOiBib29sZWFuIH0+KFxuICAgICAgKHJlc29sdmUpID0+IHtcbiAgICAgICAgY29uc3QgbmV3UGFyczogSVBhcmFtc0ludGVybmFsID0geyAuLi5wYXJzLCBvbkRvbmU6IHJlc29sdmUgfVxuICAgICAgICBydW5CdWlsZGVyUHJvY2Vzcyhjb21tYW5kLCBhcmdzLCBvcHRpb25zLCBuZXdQYXJzKVxuICAgICAgfSxcbiAgICApXG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGludGVydmFsICE9PSB1bmRlZmluZWQpIHdpbmRvdy5jbGVhckludGVydmFsKGludGVydmFsKVxuICB9XG59XG4iXX0=