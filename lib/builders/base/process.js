"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
function unindentMessage(lines) {
    const minIndent = Math.min(...lines.map((line) => {
        const match = line.match(/^\s*/);
        if (match) {
            return match[0].length;
        }
        else {
            return 0;
        }
    }));
    return lines.map((line) => line.slice(minIndent)).join('\n');
}
function parseMessage(raw, cwd, defaultSeverity) {
    if (raw.trim() !== '') {
        const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
        const matched = raw.trimRight().match(matchLoc);
        if (matched) {
            const [file, line, col, rawTyp, context, msg] = matched.slice(1);
            const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
            return [
                true,
                {
                    uri: path.isAbsolute(file) ? file : cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell',
                    },
                    severity: typ,
                },
            ];
        }
        else {
            return [
                false,
                {
                    message: raw,
                    severity: defaultSeverity,
                },
            ];
        }
    }
    return [false, undefined];
}
function runBuilderProcess(command, args, options, params) {
    const cwd = new atom_1.Directory(options.cwd || '.');
    let hasError = false;
    let severity = params.severity;
    const proc = child_process.spawn(command, args, options);
    const buffered = (handleOutput) => {
        let buffer = '';
        return (data) => {
            const output = data.toString('utf8');
            const [first, ...tail] = output.split(os_1.EOL);
            buffer += first;
            if (tail.length > 0) {
                const lines = [buffer, ...tail.slice(0, -1)];
                buffer = tail.slice(-1)[0];
                handleOutput(lines);
            }
        };
    };
    const blockBuffered = (handleOutput) => {
        const startOfMessage = /\n(?=\S)(?!\d+ \|)/g;
        let buffer = [];
        proc.on('close', () => handleOutput(buffer.join('\n')));
        return buffered((lines) => {
            buffer.push(...lines);
            const [first, ...tail] = buffer.join('\n').split(startOfMessage);
            if (tail.length > 0) {
                const last = tail.slice(-1)[0];
                buffer = last.split('\n');
                for (const block of [first, ...tail.slice(0, -1)]) {
                    handleOutput(block);
                }
            }
        });
    };
    if (params.setCancelAction) {
        params.setCancelAction(() => {
            try {
                process_1.kill(-proc.pid);
            }
            catch (e) {
            }
            try {
                process_1.kill(proc.pid);
            }
            catch (e) {
            }
            try {
                proc.kill();
            }
            catch (e) {
            }
        });
    }
    const handleMessage = (msg) => {
        if (params.onProgress) {
            const match = msg.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
            if (match) {
                const progress = match[1];
                const total = match[2];
                params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
            }
        }
        if (params.severityChangeRx) {
            for (const [sev, rx] of Object.entries(params.severityChangeRx)) {
                if (msg.match(rx)) {
                    severity = sev;
                    break;
                }
            }
        }
        let parsed;
        [hasError, parsed] = parseMessage(msg, cwd, severity);
        if (parsed && params.onMsg)
            params.onMsg(parsed);
    };
    proc.stdout.on('data', blockBuffered(handleMessage));
    proc.stderr.on('data', blockBuffered(handleMessage));
    proc.on('close', (exitCode) => {
        if (params.onDone) {
            params.onDone({ exitCode, hasError: hasError });
        }
    });
}
async function runProcess(command, args, options, pars) {
    return new Promise((resolve) => {
        const newPars = Object.assign(Object.assign({}, pars), { onDone: resolve });
        runBuilderProcess(command, args, options, newPars);
    });
}
exports.runProcess = runProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9idWlsZGVycy9iYXNlL3Byb2Nlc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQ0FBOEM7QUFDOUMscUNBQThCO0FBQzlCLDZCQUE0QjtBQUM1QiwyQkFBd0I7QUFJeEIsK0JBQXVDO0FBV3ZDLFNBQVMsZUFBZSxDQUFDLEtBQWU7SUFDdEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FDeEIsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDcEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNoQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtTQUN2QjthQUFNO1lBQ0wsT0FBTyxDQUFDLENBQUE7U0FDVDtJQUNILENBQUMsQ0FBQyxDQUNILENBQUE7SUFDRCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDOUQsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUNuQixHQUFXLEVBQ1gsR0FBYyxFQUNkLGVBQThCO0lBRTlCLElBQUksR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNyQixNQUFNLFFBQVEsR0FBRyxrRUFBa0UsQ0FBQTtRQUNuRixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQy9DLElBQUksT0FBTyxFQUFFO1lBQ1gsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNoRSxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFBO1lBRW5ELE9BQU87Z0JBQ0wsSUFBSTtnQkFDSjtvQkFDRSxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRTtvQkFDL0QsUUFBUSxFQUFFLElBQUksWUFBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNsRSxPQUFPO29CQUNQLE9BQU8sRUFBRTt3QkFDUCxJQUFJLEVBQUUsZUFBZSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ3RDLFdBQVcsRUFBRSxzQkFBc0I7cUJBQ3BDO29CQUNELFFBQVEsRUFBRSxHQUFHO2lCQUNkO2FBQ0YsQ0FBQTtTQUNGO2FBQU07WUFDTCxPQUFPO2dCQUNMLEtBQUs7Z0JBQ0w7b0JBQ0UsT0FBTyxFQUFFLEdBQUc7b0JBQ1osUUFBUSxFQUFFLGVBQWU7aUJBQzFCO2FBQ0YsQ0FBQTtTQUNGO0tBQ0Y7SUFDRCxPQUFPLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFBO0FBQzNCLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUN4QixPQUFlLEVBQ2YsSUFBYyxFQUNkLE9BQW1DLEVBQ25DLE1BQWU7SUFFZixNQUFNLEdBQUcsR0FBRyxJQUFJLGdCQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQTtJQU03QyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUE7SUFDcEIsSUFBSSxRQUFRLEdBQWtCLE1BQU0sQ0FBQyxRQUFRLENBQUE7SUFDN0MsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBRXhELE1BQU0sUUFBUSxHQUFHLENBQUMsWUFBdUMsRUFBRSxFQUFFO1FBQzNELElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUNmLE9BQU8sQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ3BDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQUcsQ0FBQyxDQUFBO1lBRzFDLE1BQU0sSUFBSSxLQUFLLENBQUE7WUFDZixJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUVuQixNQUFNLEtBQUssR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDNUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDMUIsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFBO2FBQ3BCO1FBQ0gsQ0FBQyxDQUFBO0lBQ0gsQ0FBQyxDQUFBO0lBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxZQUFxQyxFQUFFLEVBQUU7UUFFOUQsTUFBTSxjQUFjLEdBQUcscUJBQXFCLENBQUE7UUFDNUMsSUFBSSxNQUFNLEdBQWEsRUFBRSxDQUFBO1FBQ3pCLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN2RCxPQUFPLFFBQVEsQ0FBQyxDQUFDLEtBQWUsRUFBRSxFQUFFO1lBQ2xDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQTtZQUVyQixNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUE7WUFDaEUsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDbkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUM5QixNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDekIsS0FBSyxNQUFNLEtBQUssSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtvQkFDakQsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFBO2lCQUNwQjthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUE7SUFFRCxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUU7UUFDMUIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDMUIsSUFBSTtnQkFDRixjQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7YUFDaEI7WUFBQyxPQUFPLENBQUMsRUFBRTthQUVYO1lBQ0QsSUFBSTtnQkFDRixjQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQ2Y7WUFBQyxPQUFPLENBQUMsRUFBRTthQUVYO1lBQ0QsSUFBSTtnQkFDRixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUE7YUFDWjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2FBRVg7UUFDSCxDQUFDLENBQUMsQ0FBQTtLQUNIO0lBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxHQUFXLEVBQUUsRUFBRTtRQUNwQyxJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7WUFFckIsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFBO1lBQzNELElBQUksS0FBSyxFQUFFO2dCQUNULE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDekIsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUN0QixNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO2FBQ2hFO1NBQ0Y7UUFDRCxJQUFJLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTtZQUUzQixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtnQkFDL0QsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFO29CQUNqQixRQUFRLEdBQUcsR0FBRyxDQUFBO29CQUNkLE1BQUs7aUJBQ047YUFDRjtTQUNGO1FBQ0QsSUFBSSxNQUFtQyxDQUN0QztRQUFBLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxHQUFHLFlBQVksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQ3RELElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLO1lBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUNsRCxDQUFDLENBQUE7SUFJRCxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFBO0lBRXBELElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUU7UUFDNUIsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7U0FDaEQ7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFTSxLQUFLLFVBQVUsVUFBVSxDQUM5QixPQUFlLEVBQ2YsSUFBYyxFQUNkLE9BQW1DLEVBQ25DLElBQWE7SUFFYixPQUFPLElBQUksT0FBTyxDQUEwQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3RFLE1BQU0sT0FBTyxtQ0FBcUIsSUFBSSxLQUFFLE1BQU0sRUFBRSxPQUFPLEdBQUUsQ0FBQTtRQUN6RCxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUNwRCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFWRCxnQ0FVQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IGtpbGwgfSBmcm9tICdwcm9jZXNzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcblxuLy8gLy8gQXRvbSBkZXBlbmRlbmNpZXNcbmltcG9ydCB7IERpcmVjdG9yeSwgUG9pbnQgfSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbXMge1xuICByZWFkb25seSBvbk1zZz86IChtc2c6IFVQSS5JUmVzdWx0SXRlbSkgPT4gdm9pZFxuICByZWFkb25seSBvblByb2dyZXNzPzogKHByb2dyZXNzOiBudW1iZXIpID0+IHZvaWRcbiAgcmVhZG9ubHkgb25Eb25lPzogKGRvbmU6IHsgZXhpdENvZGU6IG51bWJlcjsgaGFzRXJyb3I6IGJvb2xlYW4gfSkgPT4gdm9pZFxuICByZWFkb25seSBzZXRDYW5jZWxBY3Rpb24/OiAoYWN0aW9uOiAoKSA9PiB2b2lkKSA9PiB2b2lkXG4gIHJlYWRvbmx5IHNldmVyaXR5OiBVUEkuVFNldmVyaXR5XG4gIHJlYWRvbmx5IHNldmVyaXR5Q2hhbmdlUng/OiB7IFtLIGluIFVQSS5UU2V2ZXJpdHldOiBSZWdFeHAgfVxufVxuXG5mdW5jdGlvbiB1bmluZGVudE1lc3NhZ2UobGluZXM6IHN0cmluZ1tdKSB7XG4gIGNvbnN0IG1pbkluZGVudCA9IE1hdGgubWluKFxuICAgIC4uLmxpbmVzLm1hcCgobGluZSkgPT4ge1xuICAgICAgY29uc3QgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eXFxzKi8pXG4gICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIG1hdGNoWzBdLmxlbmd0aFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIDBcbiAgICAgIH1cbiAgICB9KSxcbiAgKVxuICByZXR1cm4gbGluZXMubWFwKChsaW5lKSA9PiBsaW5lLnNsaWNlKG1pbkluZGVudCkpLmpvaW4oJ1xcbicpXG59XG5cbmZ1bmN0aW9uIHBhcnNlTWVzc2FnZShcbiAgcmF3OiBzdHJpbmcsXG4gIGN3ZDogRGlyZWN0b3J5LFxuICBkZWZhdWx0U2V2ZXJpdHk6IFVQSS5UU2V2ZXJpdHksXG4pOiBbYm9vbGVhbiwgVVBJLklSZXN1bHRJdGVtP10ge1xuICBpZiAocmF3LnRyaW0oKSAhPT0gJycpIHtcbiAgICBjb25zdCBtYXRjaExvYyA9IC9eKC4rKTooXFxkKyk6KFxcZCspOig/OiAoXFx3Kyk6KT9bIFxcdF0qKFxcW1teXFxdXStcXF0pP1sgXFx0XSpcXG4/KFteXSopL1xuICAgIGNvbnN0IG1hdGNoZWQgPSByYXcudHJpbVJpZ2h0KCkubWF0Y2gobWF0Y2hMb2MpXG4gICAgaWYgKG1hdGNoZWQpIHtcbiAgICAgIGNvbnN0IFtmaWxlLCBsaW5lLCBjb2wsIHJhd1R5cCwgY29udGV4dCwgbXNnXSA9IG1hdGNoZWQuc2xpY2UoMSlcbiAgICAgIGNvbnN0IHR5cCA9IHJhd1R5cCA/IHJhd1R5cC50b0xvd2VyQ2FzZSgpIDogJ2Vycm9yJ1xuXG4gICAgICByZXR1cm4gW1xuICAgICAgICB0cnVlLFxuICAgICAgICB7XG4gICAgICAgICAgdXJpOiBwYXRoLmlzQWJzb2x1dGUoZmlsZSkgPyBmaWxlIDogY3dkLmdldEZpbGUoZmlsZSkuZ2V0UGF0aCgpLFxuICAgICAgICAgIHBvc2l0aW9uOiBuZXcgUG9pbnQocGFyc2VJbnQobGluZSwgMTApIC0gMSwgcGFyc2VJbnQoY29sLCAxMCkgLSAxKSxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAgIHRleHQ6IHVuaW5kZW50TWVzc2FnZShtc2cuc3BsaXQoJ1xcbicpKSxcbiAgICAgICAgICAgIGhpZ2hsaWdodGVyOiAnaGludC5tZXNzYWdlLmhhc2tlbGwnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V2ZXJpdHk6IHR5cCxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgZmFsc2UsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiByYXcsXG4gICAgICAgICAgc2V2ZXJpdHk6IGRlZmF1bHRTZXZlcml0eSxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIFtmYWxzZSwgdW5kZWZpbmVkXVxufVxuXG5mdW5jdGlvbiBydW5CdWlsZGVyUHJvY2VzcyhcbiAgY29tbWFuZDogc3RyaW5nLFxuICBhcmdzOiBzdHJpbmdbXSxcbiAgb3B0aW9uczogY2hpbGRfcHJvY2Vzcy5TcGF3bk9wdGlvbnMsXG4gIHBhcmFtczogSVBhcmFtcyxcbikge1xuICBjb25zdCBjd2QgPSBuZXcgRGlyZWN0b3J5KG9wdGlvbnMuY3dkIHx8ICcuJylcbiAgLy8gY2FiYWwgcmV0dXJucyBmYWlsdXJlIHdoZW4gdGhlcmUgYXJlIHR5cGUgZXJyb3JzIF9vcl8gd2hlbiBpdCBjYW4ndFxuICAvLyBjb21waWxlIHRoZSBjb2RlIGF0IGFsbCAoaS5lLiwgd2hlbiB0aGVyZSBhcmUgbWlzc2luZyBkZXBlbmRlbmNpZXMpLlxuICAvLyBTaW5jZSBpdCdzIGhhcmQgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiB0aGVzZSB0d28sIHdlIGxvb2sgYXQgdGhlXG4gIC8vIHBhcnNlZCBlcnJvcnM7XG4gIC8vIHRoaXMuaGFzRXJyb3IgaXMgc2V0IGlmIHdlIGZpbmQgYW4gZXJyb3Ivd2FybmluZywgc2VlIHBhcnNlTWVzc2FnZVxuICBsZXQgaGFzRXJyb3IgPSBmYWxzZVxuICBsZXQgc2V2ZXJpdHk6IFVQSS5UU2V2ZXJpdHkgPSBwYXJhbXMuc2V2ZXJpdHlcbiAgY29uc3QgcHJvYyA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oY29tbWFuZCwgYXJncywgb3B0aW9ucylcblxuICBjb25zdCBidWZmZXJlZCA9IChoYW5kbGVPdXRwdXQ6IChsaW5lczogc3RyaW5nW10pID0+IHZvaWQpID0+IHtcbiAgICBsZXQgYnVmZmVyID0gJydcbiAgICByZXR1cm4gKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0ID0gZGF0YS50b1N0cmluZygndXRmOCcpXG4gICAgICBjb25zdCBbZmlyc3QsIC4uLnRhaWxdID0gb3V0cHV0LnNwbGl0KEVPTClcbiAgICAgIC8vIF4gVGhlIG9ubHkgcGxhY2Ugd2hlcmUgd2UgZ2V0IG9zLXNwZWNpZmljIEVPTCAoQ1IvQ1JMRi9MRilcbiAgICAgIC8vIGluIHRoZSByZXN0IG9mIHRoZSBjb2RlIHdlJ3JlIHVzaW5nIGp1c3QgTEYgKFxcbilcbiAgICAgIGJ1ZmZlciArPSBmaXJzdFxuICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBpdCBtZWFucyB0aGVyZSdzIGF0IGxlYXN0IG9uZSBuZXdsaW5lXG4gICAgICAgIGNvbnN0IGxpbmVzID0gW2J1ZmZlciwgLi4udGFpbC5zbGljZSgwLCAtMSldXG4gICAgICAgIGJ1ZmZlciA9IHRhaWwuc2xpY2UoLTEpWzBdXG4gICAgICAgIGhhbmRsZU91dHB1dChsaW5lcylcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBibG9ja0J1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGJsb2NrOiBzdHJpbmcpID0+IHZvaWQpID0+IHtcbiAgICAvLyBTdGFydCBvZiBhIENhYmFsIG1lc3NhZ2VcbiAgICBjb25zdCBzdGFydE9mTWVzc2FnZSA9IC9cXG4oPz1cXFMpKD8hXFxkKyBcXHwpL2dcbiAgICBsZXQgYnVmZmVyOiBzdHJpbmdbXSA9IFtdXG4gICAgcHJvYy5vbignY2xvc2UnLCAoKSA9PiBoYW5kbGVPdXRwdXQoYnVmZmVyLmpvaW4oJ1xcbicpKSlcbiAgICByZXR1cm4gYnVmZmVyZWQoKGxpbmVzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgYnVmZmVyLnB1c2goLi4ubGluZXMpXG4gICAgICAvLyBDb3VsZCBpdGVyYXRlIG92ZXIgbGluZXMgaGVyZSwgYnV0IHRoaXMgaXMgZWFzaWVyLCBpZiBub3QgYXMgZWZmZWN0aXZlXG4gICAgICBjb25zdCBbZmlyc3QsIC4uLnRhaWxdID0gYnVmZmVyLmpvaW4oJ1xcbicpLnNwbGl0KHN0YXJ0T2ZNZXNzYWdlKVxuICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBsYXN0ID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgYnVmZmVyID0gbGFzdC5zcGxpdCgnXFxuJylcbiAgICAgICAgZm9yIChjb25zdCBibG9jayBvZiBbZmlyc3QsIC4uLnRhaWwuc2xpY2UoMCwgLTEpXSkge1xuICAgICAgICAgIGhhbmRsZU91dHB1dChibG9jaylcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBpZiAocGFyYW1zLnNldENhbmNlbEFjdGlvbikge1xuICAgIHBhcmFtcy5zZXRDYW5jZWxBY3Rpb24oKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAga2lsbCgtcHJvYy5waWQpXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8qbm9vcCovXG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBraWxsKHByb2MucGlkKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvKm5vb3AqL1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgcHJvYy5raWxsKClcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLypub29wKi9cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgY29uc3QgaGFuZGxlTWVzc2FnZSA9IChtc2c6IHN0cmluZykgPT4ge1xuICAgIGlmIChwYXJhbXMub25Qcm9ncmVzcykge1xuICAgICAgLy8gY2hlY2sgcHJvZ3Jlc3NcbiAgICAgIGNvbnN0IG1hdGNoID0gbXNnLm1hdGNoKC9cXFtcXHMqKFtcXGRdKylcXHMrb2ZcXHMrKFtcXGRdKylcXHMqXFxdLylcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG1hdGNoWzFdXG4gICAgICAgIGNvbnN0IHRvdGFsID0gbWF0Y2hbMl1cbiAgICAgICAgcGFyYW1zLm9uUHJvZ3Jlc3MocGFyc2VJbnQocHJvZ3Jlc3MsIDEwKSAvIHBhcnNlSW50KHRvdGFsLCAxMCkpXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChwYXJhbXMuc2V2ZXJpdHlDaGFuZ2VSeCkge1xuICAgICAgLy8gY2hlY2sgc2V2ZXJpdHkgY2hhbmdlXG4gICAgICBmb3IgKGNvbnN0IFtzZXYsIHJ4XSBvZiBPYmplY3QuZW50cmllcyhwYXJhbXMuc2V2ZXJpdHlDaGFuZ2VSeCkpIHtcbiAgICAgICAgaWYgKG1zZy5tYXRjaChyeCkpIHtcbiAgICAgICAgICBzZXZlcml0eSA9IHNldlxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IHBhcnNlZDogVVBJLklSZXN1bHRJdGVtIHwgdW5kZWZpbmVkXG4gICAgO1toYXNFcnJvciwgcGFyc2VkXSA9IHBhcnNlTWVzc2FnZShtc2csIGN3ZCwgc2V2ZXJpdHkpXG4gICAgaWYgKHBhcnNlZCAmJiBwYXJhbXMub25Nc2cpIHBhcmFtcy5vbk1zZyhwYXJzZWQpXG4gIH1cblxuICAvLyBOb3RlOiBibG9ja0J1ZmZlcmVkIHVzZWQgdHdpY2UgYmVjYXVzZSB3ZSBuZWVkIHNlcGFyYXRlIGJ1ZmZlcnNcbiAgLy8gZm9yIHN0ZGVyciBhbmQgc3Rkb3V0XG4gIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgYmxvY2tCdWZmZXJlZChoYW5kbGVNZXNzYWdlKSlcbiAgcHJvYy5zdGRlcnIub24oJ2RhdGEnLCBibG9ja0J1ZmZlcmVkKGhhbmRsZU1lc3NhZ2UpKVxuXG4gIHByb2Mub24oJ2Nsb3NlJywgKGV4aXRDb2RlKSA9PiB7XG4gICAgaWYgKHBhcmFtcy5vbkRvbmUpIHtcbiAgICAgIHBhcmFtcy5vbkRvbmUoeyBleGl0Q29kZSwgaGFzRXJyb3I6IGhhc0Vycm9yIH0pXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcnVuUHJvY2VzcyhcbiAgY29tbWFuZDogc3RyaW5nLFxuICBhcmdzOiBzdHJpbmdbXSxcbiAgb3B0aW9uczogY2hpbGRfcHJvY2Vzcy5TcGF3bk9wdGlvbnMsXG4gIHBhcnM6IElQYXJhbXMsXG4pIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHsgZXhpdENvZGU6IG51bWJlcjsgaGFzRXJyb3I6IGJvb2xlYW4gfT4oKHJlc29sdmUpID0+IHtcbiAgICBjb25zdCBuZXdQYXJzOiB0eXBlb2YgcGFycyA9IHsgLi4ucGFycywgb25Eb25lOiByZXNvbHZlIH1cbiAgICBydW5CdWlsZGVyUHJvY2Vzcyhjb21tYW5kLCBhcmdzLCBvcHRpb25zLCBuZXdQYXJzKVxuICB9KVxufVxuIl19