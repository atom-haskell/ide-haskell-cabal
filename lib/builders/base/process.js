"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
function unindentMessage(lines) {
    const minIndent = Math.min(...lines.map((line) => {
        const match = line.match(/^\s*/);
        if (match) {
            return match[0].length;
        }
        else {
            return 0;
        }
    }));
    return lines.map((line) => line.slice(minIndent)).join('\n');
}
function parseMessage(raw, cwd, defaultSeverity) {
    if (raw.trim() !== '') {
        const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
        const matched = raw.trimRight().match(matchLoc);
        if (matched) {
            const [file, line, col, rawTyp, context, msg] = matched.slice(1);
            const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
            return [
                true,
                {
                    uri: path.isAbsolute(file) ? file : cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell',
                    },
                    severity: typ,
                },
            ];
        }
        else {
            return [
                false,
                {
                    message: raw,
                    severity: defaultSeverity,
                },
            ];
        }
    }
    return [false, undefined];
}
function runBuilderProcess(command, args, options, params) {
    const cwd = new atom_1.Directory(options.cwd || '.');
    let hasError = false;
    let severity = params.severity;
    const proc = child_process.spawn(command, args, options);
    proc.on('error', function (err) {
        atom.notifications.addError(err.name, {
            detail: err.message,
            dismissable: true,
        });
    });
    const buffered = (handleOutput) => {
        let buffer = '';
        return (data) => {
            const output = data.toString('utf8');
            const [first, ...tail] = output.split(os_1.EOL);
            buffer += first;
            if (tail.length > 0) {
                const lines = [buffer, ...tail.slice(0, -1)];
                buffer = tail.slice(-1)[0];
                handleOutput(lines);
            }
        };
    };
    const blockBuffered = (handleOutput) => {
        const startOfMessage = /\n(?=\S)(?!\d+ \|)/g;
        let buffer = [];
        proc.on('close', () => handleOutput(buffer.join('\n')));
        return buffered((lines) => {
            buffer.push(...lines);
            const [first, ...tail] = buffer.join('\n').split(startOfMessage);
            if (tail.length > 0) {
                const last = tail.slice(-1)[0];
                buffer = last.split('\n');
                for (const block of [first, ...tail.slice(0, -1)]) {
                    handleOutput(block);
                }
            }
        });
    };
    if (params.setCancelAction) {
        params.setCancelAction(() => {
            try {
                process_1.kill(-proc.pid);
            }
            catch (e) {
            }
            try {
                process_1.kill(proc.pid);
            }
            catch (e) {
            }
            try {
                proc.kill();
            }
            catch (e) {
            }
        });
    }
    const handleMessage = (msg) => {
        if (params.onProgress) {
            const match = msg.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
            if (match) {
                const progress = match[1];
                const total = match[2];
                params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
            }
        }
        if (params.severityChangeRx) {
            for (const [sev, rx] of Object.entries(params.severityChangeRx)) {
                if (msg.match(rx)) {
                    severity = sev;
                    break;
                }
            }
        }
        let parsed;
        [hasError, parsed] = parseMessage(msg, cwd, severity);
        if (parsed && params.onMsg)
            params.onMsg(parsed);
    };
    proc.stdout.on('data', blockBuffered(handleMessage));
    proc.stderr.on('data', blockBuffered(handleMessage));
    proc.on('close', (exitCode) => {
        if (params.onDone) {
            params.onDone({ exitCode, hasError: hasError });
        }
    });
}
async function runProcess(command, args, options, pars) {
    return new Promise((resolve) => {
        const newPars = Object.assign(Object.assign({}, pars), { onDone: resolve });
        runBuilderProcess(command, args, options, newPars);
    });
}
exports.runProcess = runProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9idWlsZGVycy9iYXNlL3Byb2Nlc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQ0FBOEM7QUFDOUMscUNBQThCO0FBQzlCLDZCQUE0QjtBQUM1QiwyQkFBd0I7QUFJeEIsK0JBQXVDO0FBV3ZDLFNBQVMsZUFBZSxDQUFDLEtBQWU7SUFDdEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FDeEIsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDcEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNoQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtTQUN2QjthQUFNO1lBQ0wsT0FBTyxDQUFDLENBQUE7U0FDVDtJQUNILENBQUMsQ0FBQyxDQUNILENBQUE7SUFDRCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDOUQsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUNuQixHQUFXLEVBQ1gsR0FBYyxFQUNkLGVBQThCO0lBRTlCLElBQUksR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUNyQixNQUFNLFFBQVEsR0FBRyxrRUFBa0UsQ0FBQTtRQUNuRixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQy9DLElBQUksT0FBTyxFQUFFO1lBQ1gsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUs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SUFJRCxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFBO0lBRXBELElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUU7UUFDNUIsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7U0FDaEQ7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFTSxLQUFLLFVBQVUsVUFBVSxDQUM5QixPQUFlLEVBQ2YsSUFBYyxFQUNkLE9BQW1DLEVBQ25DLElBQWE7SUFFYixPQUFPLElBQUksT0FBTyxDQUEwQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3RFLE1BQU0sT0FBTyxtQ0FBcUIsSUFBSSxLQUFFLE1BQU0sRUFBRSxPQUFPLEdBQUUsQ0FBQTtRQUN6RCxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUNwRCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFWRCxnQ0FVQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IGtpbGwgfSBmcm9tICdwcm9jZXNzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcblxuLy8gLy8gQXRvbSBkZXBlbmRlbmNpZXNcbmltcG9ydCB7IERpcmVjdG9yeSwgUG9pbnQgfSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbXMge1xuICByZWFkb25seSBvbk1zZz86IChtc2c6IFVQSS5JUmVzdWx0SXRlbSkgPT4gdm9pZFxuICByZWFkb25seSBvblByb2dyZXNzPzogKHByb2dyZXNzOiBudW1iZXIpID0+IHZvaWRcbiAgcmVhZG9ubHkgb25Eb25lPzogKGRvbmU6IHsgZXhpdENvZGU6IG51bWJlcjsgaGFzRXJyb3I6IGJvb2xlYW4gfSkgPT4gdm9pZFxuICByZWFkb25seSBzZXRDYW5jZWxBY3Rpb24/OiAoYWN0aW9uOiAoKSA9PiB2b2lkKSA9PiB2b2lkXG4gIHJlYWRvbmx5IHNldmVyaXR5OiBVUEkuVFNldmVyaXR5XG4gIHJlYWRvbmx5IHNldmVyaXR5Q2hhbmdlUng/OiB7IFtLIGluIFVQSS5UU2V2ZXJpdHldOiBSZWdFeHAgfVxufVxuXG5mdW5jdGlvbiB1bmluZGVudE1lc3NhZ2UobGluZXM6IHN0cmluZ1tdKSB7XG4gIGNvbnN0IG1pbkluZGVudCA9IE1hdGgubWluKFxuICAgIC4uLmxpbmVzLm1hcCgobGluZSkgPT4ge1xuICAgICAgY29uc3QgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eXFxzKi8pXG4gICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIG1hdGNoWzBdLmxlbmd0aFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIDBcbiAgICAgIH1cbiAgICB9KSxcbiAgKVxuICByZXR1cm4gbGluZXMubWFwKChsaW5lKSA9PiBsaW5lLnNsaWNlKG1pbkluZGVudCkpLmpvaW4oJ1xcbicpXG59XG5cbmZ1bmN0aW9uIHBhcnNlTWVzc2FnZShcbiAgcmF3OiBzdHJpbmcsXG4gIGN3ZDogRGlyZWN0b3J5LFxuICBkZWZhdWx0U2V2ZXJpdHk6IFVQSS5UU2V2ZXJpdHksXG4pOiBbYm9vbGVhbiwgVVBJLklSZXN1bHRJdGVtP10ge1xuICBpZiAocmF3LnRyaW0oKSAhPT0gJycpIHtcbiAgICBjb25zdCBtYXRjaExvYyA9IC9eKC4rKTooXFxkKyk6KFxcZCspOig/OiAoXFx3Kyk6KT9bIFxcdF0qKFxcW1teXFxdXStcXF0pP1sgXFx0XSpcXG4/KFteXSopL1xuICAgIGNvbnN0IG1hdGNoZWQgPSByYXcudHJpbVJpZ2h0KCkubWF0Y2gobWF0Y2hMb2MpXG4gICAgaWYgKG1hdGNoZWQpIHtcbiAgICAgIGNvbnN0IFtmaWxlLCBsaW5lLCBjb2wsIHJhd1R5cCwgY29udGV4dCwgbXNnXSA9IG1hdGNoZWQuc2xpY2UoMSlcbiAgICAgIGNvbnN0IHR5cCA9IHJhd1R5cCA/IHJhd1R5cC50b0xvd2VyQ2FzZSgpIDogJ2Vycm9yJ1xuXG4gICAgICByZXR1cm4gW1xuICAgICAgICB0cnVlLFxuICAgICAgICB7XG4gICAgICAgICAgdXJpOiBwYXRoLmlzQWJzb2x1dGUoZmlsZSkgPyBmaWxlIDogY3dkLmdldEZpbGUoZmlsZSkuZ2V0UGF0aCgpLFxuICAgICAgICAgIHBvc2l0aW9uOiBuZXcgUG9pbnQocGFyc2VJbnQobGluZSwgMTApIC0gMSwgcGFyc2VJbnQoY29sLCAxMCkgLSAxKSxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAgIHRleHQ6IHVuaW5kZW50TWVzc2FnZShtc2cuc3BsaXQoJ1xcbicpKSxcbiAgICAgICAgICAgIGhpZ2hsaWdodGVyOiAnaGludC5tZXNzYWdlLmhhc2tlbGwnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V2ZXJpdHk6IHR5cCxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgZmFsc2UsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiByYXcsXG4gICAgICAgICAgc2V2ZXJpdHk6IGRlZmF1bHRTZXZlcml0eSxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIFtmYWxzZSwgdW5kZWZpbmVkXVxufVxuXG5mdW5jdGlvbiBydW5CdWlsZGVyUHJvY2VzcyhcbiAgY29tbWFuZDogc3RyaW5nLFxuICBhcmdzOiBzdHJpbmdbXSxcbiAgb3B0aW9uczogY2hpbGRfcHJvY2Vzcy5TcGF3bk9wdGlvbnMsXG4gIHBhcmFtczogSVBhcmFtcyxcbikge1xuICBjb25zdCBjd2QgPSBuZXcgRGlyZWN0b3J5KG9wdGlvbnMuY3dkIHx8ICcuJylcbiAgLy8gY2FiYWwgcmV0dXJucyBmYWlsdXJlIHdoZW4gdGhlcmUgYXJlIHR5cGUgZXJyb3JzIF9vcl8gd2hlbiBpdCBjYW4ndFxuICAvLyBjb21waWxlIHRoZSBjb2RlIGF0IGFsbCAoaS5lLiwgd2hlbiB0aGVyZSBhcmUgbWlzc2luZyBkZXBlbmRlbmNpZXMpLlxuICAvLyBTaW5jZSBpdCdzIGhhcmQgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiB0aGVzZSB0d28sIHdlIGxvb2sgYXQgdGhlXG4gIC8vIHBhcnNlZCBlcnJvcnM7XG4gIC8vIHRoaXMuaGFzRXJyb3IgaXMgc2V0IGlmIHdlIGZpbmQgYW4gZXJyb3Ivd2FybmluZywgc2VlIHBhcnNlTWVzc2FnZVxuICBsZXQgaGFzRXJyb3IgPSBmYWxzZVxuICBsZXQgc2V2ZXJpdHk6IFVQSS5UU2V2ZXJpdHkgPSBwYXJhbXMuc2V2ZXJpdHlcbiAgY29uc3QgcHJvYyA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oY29tbWFuZCwgYXJncywgb3B0aW9ucylcbiAgcHJvYy5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyLm5hbWUsIHtcbiAgICAgIGRldGFpbDogZXJyLm1lc3NhZ2UsXG4gICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICB9KVxuICB9KVxuXG4gIGNvbnN0IGJ1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGxpbmVzOiBzdHJpbmdbXSkgPT4gdm9pZCkgPT4ge1xuICAgIGxldCBidWZmZXIgPSAnJ1xuICAgIHJldHVybiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXQgPSBkYXRhLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgIGNvbnN0IFtmaXJzdCwgLi4udGFpbF0gPSBvdXRwdXQuc3BsaXQoRU9MKVxuICAgICAgLy8gXiBUaGUgb25seSBwbGFjZSB3aGVyZSB3ZSBnZXQgb3Mtc3BlY2lmaWMgRU9MIChDUi9DUkxGL0xGKVxuICAgICAgLy8gaW4gdGhlIHJlc3Qgb2YgdGhlIGNvZGUgd2UncmUgdXNpbmcganVzdCBMRiAoXFxuKVxuICAgICAgYnVmZmVyICs9IGZpcnN0XG4gICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIGl0IG1lYW5zIHRoZXJlJ3MgYXQgbGVhc3Qgb25lIG5ld2xpbmVcbiAgICAgICAgY29uc3QgbGluZXMgPSBbYnVmZmVyLCAuLi50YWlsLnNsaWNlKDAsIC0xKV1cbiAgICAgICAgYnVmZmVyID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgaGFuZGxlT3V0cHV0KGxpbmVzKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGJsb2NrQnVmZmVyZWQgPSAoaGFuZGxlT3V0cHV0OiAoYmxvY2s6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICAgIC8vIFN0YXJ0IG9mIGEgQ2FiYWwgbWVzc2FnZVxuICAgIGNvbnN0IHN0YXJ0T2ZNZXNzYWdlID0gL1xcbig/PVxcUykoPyFcXGQrIFxcfCkvZ1xuICAgIGxldCBidWZmZXI6IHN0cmluZ1tdID0gW11cbiAgICBwcm9jLm9uKCdjbG9zZScsICgpID0+IGhhbmRsZU91dHB1dChidWZmZXIuam9pbignXFxuJykpKVxuICAgIHJldHVybiBidWZmZXJlZCgobGluZXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICBidWZmZXIucHVzaCguLi5saW5lcylcbiAgICAgIC8vIENvdWxkIGl0ZXJhdGUgb3ZlciBsaW5lcyBoZXJlLCBidXQgdGhpcyBpcyBlYXNpZXIsIGlmIG5vdCBhcyBlZmZlY3RpdmVcbiAgICAgIGNvbnN0IFtmaXJzdCwgLi4udGFpbF0gPSBidWZmZXIuam9pbignXFxuJykuc3BsaXQoc3RhcnRPZk1lc3NhZ2UpXG4gICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGxhc3QgPSB0YWlsLnNsaWNlKC0xKVswXVxuICAgICAgICBidWZmZXIgPSBsYXN0LnNwbGl0KCdcXG4nKVxuICAgICAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIFtmaXJzdCwgLi4udGFpbC5zbGljZSgwLCAtMSldKSB7XG4gICAgICAgICAgaGFuZGxlT3V0cHV0KGJsb2NrKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGlmIChwYXJhbXMuc2V0Q2FuY2VsQWN0aW9uKSB7XG4gICAgcGFyYW1zLnNldENhbmNlbEFjdGlvbigoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBraWxsKC1wcm9jLnBpZClcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLypub29wKi9cbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGtpbGwocHJvYy5waWQpXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8qbm9vcCovXG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBwcm9jLmtpbGwoKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvKm5vb3AqL1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBjb25zdCBoYW5kbGVNZXNzYWdlID0gKG1zZzogc3RyaW5nKSA9PiB7XG4gICAgaWYgKHBhcmFtcy5vblByb2dyZXNzKSB7XG4gICAgICAvLyBjaGVjayBwcm9ncmVzc1xuICAgICAgY29uc3QgbWF0Y2ggPSBtc2cubWF0Y2goL1xcW1xccyooW1xcZF0rKVxccytvZlxccysoW1xcZF0rKVxccypcXF0vKVxuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gbWF0Y2hbMV1cbiAgICAgICAgY29uc3QgdG90YWwgPSBtYXRjaFsyXVxuICAgICAgICBwYXJhbXMub25Qcm9ncmVzcyhwYXJzZUludChwcm9ncmVzcywgMTApIC8gcGFyc2VJbnQodG90YWwsIDEwKSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSB7XG4gICAgICAvLyBjaGVjayBzZXZlcml0eSBjaGFuZ2VcbiAgICAgIGZvciAoY29uc3QgW3NldiwgcnhdIG9mIE9iamVjdC5lbnRyaWVzKHBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSkge1xuICAgICAgICBpZiAobXNnLm1hdGNoKHJ4KSkge1xuICAgICAgICAgIHNldmVyaXR5ID0gc2V2XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBsZXQgcGFyc2VkOiBVUEkuSVJlc3VsdEl0ZW0gfCB1bmRlZmluZWRcbiAgICA7W2hhc0Vycm9yLCBwYXJzZWRdID0gcGFyc2VNZXNzYWdlKG1zZywgY3dkLCBzZXZlcml0eSlcbiAgICBpZiAocGFyc2VkICYmIHBhcmFtcy5vbk1zZykgcGFyYW1zLm9uTXNnKHBhcnNlZClcbiAgfVxuXG4gIC8vIE5vdGU6IGJsb2NrQnVmZmVyZWQgdXNlZCB0d2ljZSBiZWNhdXNlIHdlIG5lZWQgc2VwYXJhdGUgYnVmZmVyc1xuICAvLyBmb3Igc3RkZXJyIGFuZCBzdGRvdXRcbiAgcHJvYy5zdGRvdXQub24oJ2RhdGEnLCBibG9ja0J1ZmZlcmVkKGhhbmRsZU1lc3NhZ2UpKVxuICBwcm9jLnN0ZGVyci5vbignZGF0YScsIGJsb2NrQnVmZmVyZWQoaGFuZGxlTWVzc2FnZSkpXG5cbiAgcHJvYy5vbignY2xvc2UnLCAoZXhpdENvZGUpID0+IHtcbiAgICBpZiAocGFyYW1zLm9uRG9uZSkge1xuICAgICAgcGFyYW1zLm9uRG9uZSh7IGV4aXRDb2RlLCBoYXNFcnJvcjogaGFzRXJyb3IgfSlcbiAgICB9XG4gIH0pXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5Qcm9jZXNzKFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIGFyZ3M6IHN0cmluZ1tdLFxuICBvcHRpb25zOiBjaGlsZF9wcm9jZXNzLlNwYXduT3B0aW9ucyxcbiAgcGFyczogSVBhcmFtcyxcbikge1xuICByZXR1cm4gbmV3IFByb21pc2U8eyBleGl0Q29kZTogbnVtYmVyOyBoYXNFcnJvcjogYm9vbGVhbiB9PigocmVzb2x2ZSkgPT4ge1xuICAgIGNvbnN0IG5ld1BhcnM6IHR5cGVvZiBwYXJzID0geyAuLi5wYXJzLCBvbkRvbmU6IHJlc29sdmUgfVxuICAgIHJ1bkJ1aWxkZXJQcm9jZXNzKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMsIG5ld1BhcnMpXG4gIH0pXG59XG4iXX0=