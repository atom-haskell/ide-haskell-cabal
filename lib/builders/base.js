"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const cabal_process_1 = require("./cabal-process");
class BuilderBase {
    constructor(processName, opts) {
        this.processName = processName;
        this.opts = opts;
        this.spawnOpts = this.getSpawnOpts();
        this.cabalArgs = [];
    }
    async runCommand(cmd) {
        return this[cmd]();
    }
    async runCabal(extraArgs = []) {
        return cabal_process_1.runCabalProcess(this.processName, this.cabalArgs.concat(extraArgs), this.spawnOpts, this.opts.opts);
    }
    getConfigOpt(opt) {
        const map = {
            '7.2': atom.config.get('ide-haskell-cabal.cabal.ghc702'),
            '7.4': atom.config.get('ide-haskell-cabal.cabal.ghc704'),
            '7.6': atom.config.get('ide-haskell-cabal.cabal.ghc706'),
            '7.8': atom.config.get('ide-haskell-cabal.cabal.ghc708'),
            '7.10': atom.config.get('ide-haskell-cabal.cabal.ghc710'),
            '8.0': atom.config.get('ide-haskell-cabal.cabal.ghc800'),
        };
        return map[atom.config.get('ide-haskell-cabal.cabal.activeGhcVersion')][opt];
    }
    getSpawnOpts() {
        const opts = {
            cwd: this.opts.cabalRoot.getPath(),
            detached: true,
            env: {},
        };
        const env = Object.assign({}, process.env);
        if (process.platform === 'win32') {
            const path = [];
            const capMask = (str, mask) => {
                const a = str.split('');
                for (let i = 0; i < a.length; i++) {
                    if (mask & Math.pow(2, i)) {
                        a[i] = a[i].toUpperCase();
                    }
                }
                return a.join('');
            };
            for (let m = 0b1111; m >= 0; m--) {
                const vn = capMask('path', m);
                const evn = env[vn];
                if (evn !== undefined) {
                    path.push(evn);
                }
            }
            env['PATH'] = path.join(path_1.delimiter);
        }
        const ghcPath = this.getConfigOpt('pathTo');
        if (this.getConfigOpt('pathExclusive')) {
            env['PATH'] = ghcPath.join(path_1.delimiter);
        }
        else if (ghcPath) {
            env['PATH'] = ghcPath.concat((env['PATH'] || '').split(path_1.delimiter)).join(path_1.delimiter);
        }
        const sandboxConfig = this.getConfigOpt('sandbox');
        if (sandboxConfig !== '') {
            env['CABAL_SANDBOX_CONFIG'] = sandboxConfig;
        }
        opts.env = env;
        return opts;
    }
}
exports.BuilderBase = BuilderBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQWdDO0FBSWhDLG1EQUEwRDtBQWlCMUQ7SUFJRSxZQUNVLFdBQW1CLEVBQ2pCLElBQWM7UUFEaEIsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFDakIsU0FBSSxHQUFKLElBQUksQ0FBVTtRQUV4QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUNwQyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtJQUNyQixDQUFDO0lBRU0sS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFpQjtRQUN2QyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUE7SUFDcEIsQ0FBQztJQVFTLEtBQUssQ0FBQyxRQUFRLENBQUMsWUFBc0IsRUFBRTtRQUMvQyxNQUFNLENBQUMsK0JBQWUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM1RyxDQUFDO0lBRVMsWUFBWSxDQUE4QixHQUFNO1FBQ3hELE1BQU0sR0FBRyxHQUFHO1lBQ1YsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxDQUFDO1lBQ3hELEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsQ0FBQztZQUN4RCxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLENBQUM7WUFDeEQsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxDQUFDO1lBQ3hELE1BQU0sRUFBRSxJQUFJLENB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QyxDQUFDLGFBQWEsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLGFBQWEsQ0FBQTtRQUM3QyxDQUFDO1FBRUQsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUE7UUFDZCxNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ2IsQ0FBQztDQUVGO0FBMUZELGtDQTBGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlbGltaXRlciB9IGZyb20gJ3BhdGgnXG5cbmltcG9ydCB7IENhYmFsQ29tbWFuZCwgVGFyZ2V0UGFyYW1UeXBlIH0gZnJvbSAnLi8uLi9jb21tb24nXG5cbmltcG9ydCB7IHJ1bkNhYmFsUHJvY2VzcywgSVBhcmFtcyB9IGZyb20gJy4vY2FiYWwtcHJvY2VzcydcbmltcG9ydCB7IERpcmVjdG9yeSB9IGZyb20gJ2F0b20nXG5leHBvcnQgeyBJUGFyYW1zIH1cblxuZXhwb3J0IGludGVyZmFjZSBDdG9yT3B0cyB7XG4gIG9wdHM6IElQYXJhbXMsXG4gIHRhcmdldDogVGFyZ2V0UGFyYW1UeXBlLFxuICBjYWJhbFJvb3Q6IERpcmVjdG9yeVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlc3VsdFR5cGUge1xuICBleGl0Q29kZTogbnVtYmVyIHwgbnVsbFxuICBoYXNFcnJvcjogYm9vbGVhblxufVxuXG5leHBvcnQgdHlwZSBUQnVpbGRlckJhc2UgPSB7W0sgaW4gQ2FiYWxDb21tYW5kXTogKCkgPT4gUHJvbWlzZTxSZXN1bHRUeXBlPn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJ1aWxkZXJCYXNlIGltcGxlbWVudHMgVEJ1aWxkZXJCYXNlIHtcbiAgcHJvdGVjdGVkIGNhYmFsQXJnczogc3RyaW5nW11cbiAgcHJvdGVjdGVkIHNwYXduT3B0czogeyBjd2Q6IHN0cmluZywgZGV0YWNoZWQ6IGJvb2xlYW4sIGVudjogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCB1bmRlZmluZWQgfSB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBwcm9jZXNzTmFtZTogc3RyaW5nLFxuICAgIHByb3RlY3RlZCBvcHRzOiBDdG9yT3B0cyxcbiAgKSB7XG4gICAgdGhpcy5zcGF3bk9wdHMgPSB0aGlzLmdldFNwYXduT3B0cygpXG4gICAgdGhpcy5jYWJhbEFyZ3MgPSBbXVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJ1bkNvbW1hbmQoY21kOiBDYWJhbENvbW1hbmQpOiBQcm9taXNlPFJlc3VsdFR5cGU+IHtcbiAgICByZXR1cm4gdGhpc1tjbWRdKClcbiAgfVxuXG4gIHB1YmxpYyBhYnN0cmFjdCBidWlsZCgpOiBQcm9taXNlPFJlc3VsdFR5cGU+XG4gIHB1YmxpYyBhYnN0cmFjdCB0ZXN0KCk6IFByb21pc2U8UmVzdWx0VHlwZT5cbiAgcHVibGljIGFic3RyYWN0IGJlbmNoKCk6IFByb21pc2U8UmVzdWx0VHlwZT5cbiAgcHVibGljIGFic3RyYWN0IGNsZWFuKCk6IFByb21pc2U8UmVzdWx0VHlwZT5cbiAgcHVibGljIGFic3RyYWN0IGRlcHMoKTogUHJvbWlzZTxSZXN1bHRUeXBlPlxuXG4gIHByb3RlY3RlZCBhc3luYyBydW5DYWJhbChleHRyYUFyZ3M6IHN0cmluZ1tdID0gW10pOiBQcm9taXNlPFJlc3VsdFR5cGU+IHtcbiAgICByZXR1cm4gcnVuQ2FiYWxQcm9jZXNzKHRoaXMucHJvY2Vzc05hbWUsIHRoaXMuY2FiYWxBcmdzLmNvbmNhdChleHRyYUFyZ3MpLCB0aGlzLnNwYXduT3B0cywgdGhpcy5vcHRzLm9wdHMpXG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0Q29uZmlnT3B0PEsgZXh0ZW5kcyBrZXlvZiBHSENWZXJQcm9wcz4ob3B0OiBLKTogR0hDVmVyUHJvcHNbS10ge1xuICAgIGNvbnN0IG1hcCA9IHtcbiAgICAgICc3LjInOiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWNhYmFsLmNhYmFsLmdoYzcwMicpLFxuICAgICAgJzcuNCc6IGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtY2FiYWwuY2FiYWwuZ2hjNzA0JyksXG4gICAgICAnNy42JzogYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1jYWJhbC5jYWJhbC5naGM3MDYnKSxcbiAgICAgICc3LjgnOiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWNhYmFsLmNhYmFsLmdoYzcwOCcpLFxuICAgICAgJzcuMTAnOiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWNhYmFsLmNhYmFsLmdoYzcxMCcpLFxuICAgICAgJzguMCc6IGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtY2FiYWwuY2FiYWwuZ2hjODAwJyksXG4gICAgfVxuICAgIHJldHVybiBtYXBbYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1jYWJhbC5jYWJhbC5hY3RpdmVHaGNWZXJzaW9uJyldW29wdF1cbiAgfVxuXG4gIC8qIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbCAqL1xuICBwcml2YXRlIGdldFNwYXduT3B0cygpIHtcbiAgICAvLyBTZXR1cCBkZWZhdWx0IG9wdHNcbiAgICBjb25zdCBvcHRzID0ge1xuICAgICAgY3dkOiB0aGlzLm9wdHMuY2FiYWxSb290LmdldFBhdGgoKSxcbiAgICAgIGRldGFjaGVkOiB0cnVlLFxuICAgICAgZW52OiB7fSxcbiAgICB9XG5cbiAgICBjb25zdCBlbnYgPSB7IC4uLnByb2Nlc3MuZW52IH1cblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdG90YWxpdHktY2hlY2tcbiAgICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICAgICAgY29uc3QgcGF0aDogc3RyaW5nW10gPSBbXVxuICAgICAgY29uc3QgY2FwTWFzayA9IChzdHI6IHN0cmluZywgbWFzazogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGEgPSBzdHIuc3BsaXQoJycpXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tYml0d2lzZVxuICAgICAgICAgIGlmIChtYXNrICYgTWF0aC5wb3coMiwgaSkpIHtcbiAgICAgICAgICAgIGFbaV0gPSBhW2ldLnRvVXBwZXJDYXNlKClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGEuam9pbignJylcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IG0gPSAwYjExMTE7IG0gPj0gMDsgbS0tKSB7XG4gICAgICAgIGNvbnN0IHZuID0gY2FwTWFzaygncGF0aCcsIG0pXG4gICAgICAgIGNvbnN0IGV2biA9IGVudlt2bl1cbiAgICAgICAgaWYgKGV2biAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcGF0aC5wdXNoKGV2bilcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZW52WydQQVRIJ10gPSBwYXRoLmpvaW4oZGVsaW1pdGVyKVxuICAgIH1cblxuICAgIC8vIHNldCBQQVRIIGRlcGVuZGluZyBvbiBjb25maWcgc2V0dGluZ3NcbiAgICBjb25zdCBnaGNQYXRoID0gdGhpcy5nZXRDb25maWdPcHQoJ3BhdGhUbycpXG4gICAgaWYgKHRoaXMuZ2V0Q29uZmlnT3B0KCdwYXRoRXhjbHVzaXZlJykpIHtcbiAgICAgIGVudlsnUEFUSCddID0gZ2hjUGF0aC5qb2luKGRlbGltaXRlcilcbiAgICB9IGVsc2UgaWYgKGdoY1BhdGgpIHtcbiAgICAgIGVudlsnUEFUSCddID0gZ2hjUGF0aC5jb25jYXQoKGVudlsnUEFUSCddIHx8ICcnKS5zcGxpdChkZWxpbWl0ZXIpKS5qb2luKGRlbGltaXRlcilcbiAgICB9XG5cbiAgICAvLyBTZXQgc2FuZGJveCBmaWxlIChpZiBzcGVjaWZpZWQpXG4gICAgY29uc3Qgc2FuZGJveENvbmZpZyA9IHRoaXMuZ2V0Q29uZmlnT3B0KCdzYW5kYm94JylcbiAgICBpZiAoc2FuZGJveENvbmZpZyAhPT0gJycpIHtcbiAgICAgIGVudlsnQ0FCQUxfU0FOREJPWF9DT05GSUcnXSA9IHNhbmRib3hDb25maWdcbiAgICB9XG5cbiAgICBvcHRzLmVudiA9IGVudlxuICAgIHJldHVybiBvcHRzXG4gIH1cbiAgLyogdHNsaW50OmVuYWJsZTogbm8tc3RyaW5nLWxpdGVyYWwgKi9cbn1cbiJdfQ==