"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const cabal_process_1 = require("./cabal-process");
class BuilderBase {
    constructor(processName, opts) {
        this.processName = processName;
        this.opts = opts;
        this.spawnOpts = this.getSpawnOpts();
        this.cabalArgs = [];
    }
    async runCommand(cmd) {
        return this[cmd]();
    }
    async runCabal(extraArgs = []) {
        return cabal_process_1.runCabalProcess(this.processName, this.cabalArgs.concat(extraArgs), this.spawnOpts, this.opts.opts);
    }
    getConfigOpt(opt) {
        const map = {
            '7.2': atom.config.get('ide-haskell-cabal.cabal.ghc702'),
            '7.4': atom.config.get('ide-haskell-cabal.cabal.ghc704'),
            '7.6': atom.config.get('ide-haskell-cabal.cabal.ghc706'),
            '7.8': atom.config.get('ide-haskell-cabal.cabal.ghc708'),
            '7.10': atom.config.get('ide-haskell-cabal.cabal.ghc710'),
            '8.0': atom.config.get('ide-haskell-cabal.cabal.ghc800'),
        };
        return map[atom.config.get('ide-haskell-cabal.cabal.activeGhcVersion')][opt];
    }
    getSpawnOpts() {
        const opts = {
            cwd: this.opts.cabalRoot.getPath(),
            detached: true,
            env: {},
        };
        const env = Object.assign({}, process.env);
        if (process.platform === 'win32') {
            const path = [];
            const capMask = (str, mask) => {
                const a = str.split('');
                for (let i = 0; i < a.length; i++) {
                    if (mask & Math.pow(2, i)) {
                        a[i] = a[i].toUpperCase();
                    }
                }
                return a.join('');
            };
            for (let m = 0b1111; m >= 0; m--) {
                const vn = capMask('path', m);
                const evn = env[vn];
                if (evn !== undefined) {
                    path.push(evn);
                }
            }
            env['PATH'] = path.join(path_1.delimiter);
        }
        const ghcPath = this.getConfigOpt('pathTo');
        if (this.getConfigOpt('pathExclusive')) {
            env['PATH'] = ghcPath.join(path_1.delimiter);
        }
        else if (ghcPath) {
            env['PATH'] = ghcPath
                .concat((env['PATH'] || '').split(path_1.delimiter))
                .join(path_1.delimiter);
        }
        const sandboxConfig = this.getConfigOpt('sandbox');
        if (sandboxConfig !== '') {
            env['CABAL_SANDBOX_CONFIG'] = sandboxConfig;
        }
        opts.env = env;
        return opts;
    }
}
exports.BuilderBase = BuilderBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQWdDO0FBSWhDLG1EQUEwRDtBQWlCMUQ7SUFRRSxZQUFvQixXQUFtQixFQUFZLElBQWM7UUFBN0MsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFBWSxTQUFJLEdBQUosSUFBSSxDQUFVO1FBQy9ELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBQ3BDLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFBO0lBQ3JCLENBQUM7SUFFTSxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQWlCO1FBQ3ZDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQTtJQUNwQixDQUFDO0lBUVMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxZQUFzQixFQUFFO1FBQy9DLE1BQU0sQ0FBQywrQkFBZSxDQUNwQixJQUFJLENBQUMsV0FBVyxFQUNoQixJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFDaEMsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDZixDQUFBO0lBQ0gsQ0FBQztJQUVTLFlBQVksQ0FBOEIsR0FBTTtRQUN4RCxNQUFNLEdBQUcsR0FBRztZQUNWLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsQ0FBQztZQUN4RCxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLENBQUM7WUFDeEQsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxDQUFDO1lBQ3hELEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsQ0FBQztZQUN4RCxNQUFNLEVBQUUsSUFBSSxD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RSxDQUFDLENBQUMsYUFBYSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDekIsR0FBRyxDQUFDLHNCQUFzQixDQUFDLEdBQUcsYUFBYSxDQUFBO1FBQzdDLENBQUM7UUFFRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQTtRQUNkLE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDYixDQUFDO0NBRUY7QUFsR0Qsa0NBa0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVsaW1pdGVyIH0gZnJvbSAncGF0aCdcblxuaW1wb3J0IHsgQ2FiYWxDb21tYW5kLCBUYXJnZXRQYXJhbVR5cGVGb3JCdWlsZGVyIH0gZnJvbSAnLi8uLi9jb21tb24nXG5cbmltcG9ydCB7IHJ1bkNhYmFsUHJvY2VzcywgSVBhcmFtcyB9IGZyb20gJy4vY2FiYWwtcHJvY2VzcydcbmltcG9ydCB7IERpcmVjdG9yeSB9IGZyb20gJ2F0b20nXG5leHBvcnQgeyBJUGFyYW1zIH1cblxuZXhwb3J0IGludGVyZmFjZSBDdG9yT3B0cyB7XG4gIG9wdHM6IElQYXJhbXNcbiAgdGFyZ2V0OiBUYXJnZXRQYXJhbVR5cGVGb3JCdWlsZGVyXG4gIGNhYmFsUm9vdDogRGlyZWN0b3J5XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzdWx0VHlwZSB7XG4gIGV4aXRDb2RlOiBudW1iZXIgfCBudWxsXG4gIGhhc0Vycm9yOiBib29sZWFuXG59XG5cbmV4cG9ydCB0eXBlIFRCdWlsZGVyQmFzZSA9IHsgW0sgaW4gQ2FiYWxDb21tYW5kXTogKCkgPT4gUHJvbWlzZTxSZXN1bHRUeXBlPiB9XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBCdWlsZGVyQmFzZSBpbXBsZW1lbnRzIFRCdWlsZGVyQmFzZSB7XG4gIHByb3RlY3RlZCBjYWJhbEFyZ3M6IHN0cmluZ1tdXG4gIHByb3RlY3RlZCBzcGF3bk9wdHM6IHtcbiAgICBjd2Q6IHN0cmluZ1xuICAgIGRldGFjaGVkOiBib29sZWFuXG4gICAgZW52OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IHVuZGVmaW5lZCB9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHByb2Nlc3NOYW1lOiBzdHJpbmcsIHByb3RlY3RlZCBvcHRzOiBDdG9yT3B0cykge1xuICAgIHRoaXMuc3Bhd25PcHRzID0gdGhpcy5nZXRTcGF3bk9wdHMoKVxuICAgIHRoaXMuY2FiYWxBcmdzID0gW11cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBydW5Db21tYW5kKGNtZDogQ2FiYWxDb21tYW5kKTogUHJvbWlzZTxSZXN1bHRUeXBlPiB7XG4gICAgcmV0dXJuIHRoaXNbY21kXSgpXG4gIH1cblxuICBwdWJsaWMgYWJzdHJhY3QgYnVpbGQoKTogUHJvbWlzZTxSZXN1bHRUeXBlPlxuICBwdWJsaWMgYWJzdHJhY3QgdGVzdCgpOiBQcm9taXNlPFJlc3VsdFR5cGU+XG4gIHB1YmxpYyBhYnN0cmFjdCBiZW5jaCgpOiBQcm9taXNlPFJlc3VsdFR5cGU+XG4gIHB1YmxpYyBhYnN0cmFjdCBjbGVhbigpOiBQcm9taXNlPFJlc3VsdFR5cGU+XG4gIHB1YmxpYyBhYnN0cmFjdCBkZXBzKCk6IFByb21pc2U8UmVzdWx0VHlwZT5cblxuICBwcm90ZWN0ZWQgYXN5bmMgcnVuQ2FiYWwoZXh0cmFBcmdzOiBzdHJpbmdbXSA9IFtdKTogUHJvbWlzZTxSZXN1bHRUeXBlPiB7XG4gICAgcmV0dXJuIHJ1bkNhYmFsUHJvY2VzcyhcbiAgICAgIHRoaXMucHJvY2Vzc05hbWUsXG4gICAgICB0aGlzLmNhYmFsQXJncy5jb25jYXQoZXh0cmFBcmdzKSxcbiAgICAgIHRoaXMuc3Bhd25PcHRzLFxuICAgICAgdGhpcy5vcHRzLm9wdHMsXG4gICAgKVxuICB9XG5cbiAgcHJvdGVjdGVkIGdldENvbmZpZ09wdDxLIGV4dGVuZHMga2V5b2YgR0hDVmVyUHJvcHM+KG9wdDogSyk6IEdIQ1ZlclByb3BzW0tdIHtcbiAgICBjb25zdCBtYXAgPSB7XG4gICAgICAnNy4yJzogYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1jYWJhbC5jYWJhbC5naGM3MDInKSxcbiAgICAgICc3LjQnOiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWNhYmFsLmNhYmFsLmdoYzcwNCcpLFxuICAgICAgJzcuNic6IGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtY2FiYWwuY2FiYWwuZ2hjNzA2JyksXG4gICAgICAnNy44JzogYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1jYWJhbC5jYWJhbC5naGM3MDgnKSxcbiAgICAgICc3LjEwJzogYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1jYWJhbC5jYWJhbC5naGM3MTAnKSxcbiAgICAgICc4LjAnOiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWNhYmFsLmNhYmFsLmdoYzgwMCcpLFxuICAgIH1cbiAgICByZXR1cm4gbWFwW2F0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtY2FiYWwuY2FiYWwuYWN0aXZlR2hjVmVyc2lvbicpXVtvcHRdXG4gIH1cblxuICAvKiB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWwgKi9cbiAgcHJpdmF0ZSBnZXRTcGF3bk9wdHMoKSB7XG4gICAgLy8gU2V0dXAgZGVmYXVsdCBvcHRzXG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIGN3ZDogdGhpcy5vcHRzLmNhYmFsUm9vdC5nZXRQYXRoKCksXG4gICAgICBkZXRhY2hlZDogdHJ1ZSxcbiAgICAgIGVudjoge30sXG4gICAgfVxuXG4gICAgY29uc3QgZW52ID0geyAuLi5wcm9jZXNzLmVudiB9XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHRvdGFsaXR5LWNoZWNrXG4gICAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpIHtcbiAgICAgIGNvbnN0IHBhdGg6IHN0cmluZ1tdID0gW11cbiAgICAgIGNvbnN0IGNhcE1hc2sgPSAoc3RyOiBzdHJpbmcsIG1hc2s6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBhID0gc3RyLnNwbGl0KCcnKVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWJpdHdpc2VcbiAgICAgICAgICBpZiAobWFzayAmIE1hdGgucG93KDIsIGkpKSB7XG4gICAgICAgICAgICBhW2ldID0gYVtpXS50b1VwcGVyQ2FzZSgpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhLmpvaW4oJycpXG4gICAgICB9XG4gICAgICBmb3IgKGxldCBtID0gMGIxMTExOyBtID49IDA7IG0tLSkge1xuICAgICAgICBjb25zdCB2biA9IGNhcE1hc2soJ3BhdGgnLCBtKVxuICAgICAgICBjb25zdCBldm4gPSBlbnZbdm5dXG4gICAgICAgIGlmIChldm4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHBhdGgucHVzaChldm4pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVudlsnUEFUSCddID0gcGF0aC5qb2luKGRlbGltaXRlcilcbiAgICB9XG5cbiAgICAvLyBzZXQgUEFUSCBkZXBlbmRpbmcgb24gY29uZmlnIHNldHRpbmdzXG4gICAgY29uc3QgZ2hjUGF0aCA9IHRoaXMuZ2V0Q29uZmlnT3B0KCdwYXRoVG8nKVxuICAgIGlmICh0aGlzLmdldENvbmZpZ09wdCgncGF0aEV4Y2x1c2l2ZScpKSB7XG4gICAgICBlbnZbJ1BBVEgnXSA9IGdoY1BhdGguam9pbihkZWxpbWl0ZXIpXG4gICAgfSBlbHNlIGlmIChnaGNQYXRoKSB7XG4gICAgICBlbnZbJ1BBVEgnXSA9IGdoY1BhdGhcbiAgICAgICAgLmNvbmNhdCgoZW52WydQQVRIJ10gfHwgJycpLnNwbGl0KGRlbGltaXRlcikpXG4gICAgICAgIC5qb2luKGRlbGltaXRlcilcbiAgICB9XG5cbiAgICAvLyBTZXQgc2FuZGJveCBmaWxlIChpZiBzcGVjaWZpZWQpXG4gICAgY29uc3Qgc2FuZGJveENvbmZpZyA9IHRoaXMuZ2V0Q29uZmlnT3B0KCdzYW5kYm94JylcbiAgICBpZiAoc2FuZGJveENvbmZpZyAhPT0gJycpIHtcbiAgICAgIGVudlsnQ0FCQUxfU0FOREJPWF9DT05GSUcnXSA9IHNhbmRib3hDb25maWdcbiAgICB9XG5cbiAgICBvcHRzLmVudiA9IGVudlxuICAgIHJldHVybiBvcHRzXG4gIH1cbiAgLyogdHNsaW50OmVuYWJsZTogbm8tc3RyaW5nLWxpdGVyYWwgKi9cbn1cbiJdfQ==