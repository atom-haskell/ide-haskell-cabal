"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
class CabalProcess {
    constructor(command, args, options, params) {
        this.params = params;
        this.cwd = new atom_1.Directory(options.cwd || '.');
        this.running = true;
        this.hasError = false;
        const proc = child_process.spawn(command, args, options);
        const buffered = (handleOutput) => {
            let buffer = '';
            return (data) => {
                const output = data.toString('utf8');
                const [first, ...tail] = output.split(os_1.EOL);
                buffer += first;
                if (tail.length > 0) {
                    const lines = [buffer, ...(tail.slice(0, -1))];
                    buffer = tail.slice(-1)[0];
                    handleOutput(lines);
                }
            };
        };
        const blockBuffered = (handleOutput) => {
            const startOfMessage = /\n(?=\S)/g;
            let buffer = [];
            proc.on('close', () => handleOutput(buffer.join('\n')));
            return buffered((lines) => {
                buffer.push(...lines);
                const [first, ...tail] = buffer.join('\n').split(startOfMessage);
                if (tail.length > 0) {
                    const last = tail.slice(-1)[0];
                    buffer = last.split('\n');
                    for (const block of [first, ...(tail.slice(0, -1))]) {
                        handleOutput(block);
                    }
                }
            });
        };
        if (this.params.setCancelAction) {
            this.params.setCancelAction(() => {
                try {
                    process_1.kill(-proc.pid);
                }
                catch (e) { }
                try {
                    process_1.kill(proc.pid);
                }
                catch (e) { }
                try {
                    proc.kill();
                }
                catch (e) { }
            });
        }
        const handleMessage = (msg) => {
            this.checkProgress(msg);
            this.checkSeverityChange(msg);
            const parsed = this.parseMessage(msg);
            if (parsed && this.params.onMsg) {
                this.params.onMsg(parsed);
            }
        };
        proc.stdout.on('data', blockBuffered(handleMessage));
        proc.stderr.on('data', blockBuffered(handleMessage));
        proc.on('close', (exitCode, signal) => {
            if (this.params.onDone) {
                this.params.onDone({ exitCode, hasError: this.hasError });
            }
            this.running = false;
        });
    }
    unindentMessage(lines) {
        const minIndent = Math.min(...(lines.map((line) => {
            const match = line.match(/^\s*/);
            if (match) {
                return match[0].length;
            }
            else {
                return 0;
            }
        })));
        return lines.map((line) => line.slice(minIndent)).join('\n');
    }
    parseMessage(raw) {
        if (raw.trim() !== '') {
            const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
            const matched = raw.trimRight().match(matchLoc);
            if (matched) {
                this.hasError = true;
                const [file, line, col, rawTyp, context, msg] = matched.slice(1);
                const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
                return {
                    uri: path.isAbsolute(file) ? file : this.cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: this.unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell'
                    },
                    severity: typ
                };
            }
            else {
                return {
                    message: raw,
                    severity: this.params.severity
                };
            }
        }
    }
    checkSeverityChange(data) {
        if (!this.params.severityChangeRx) {
            return;
        }
        for (const [sev, rx] of Object.entries(this.params.severityChangeRx)) {
            if (data.match(rx)) {
                this.params.severity = sev;
                break;
            }
        }
    }
    checkProgress(data) {
        const match = data.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
        if (match) {
            const progress = match[1], total = match[2];
            this.params.onProgress && this.params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
        }
    }
}
function runCabalProcess(command, args, options, pars) {
    return __awaiter(this, void 0, void 0, function* () {
        const newPars = Object.assign({}, pars);
        return new Promise((resolve) => {
            newPars.onDone = resolve;
            new CabalProcess(command, args, options, newPars);
        });
    });
}
exports.runCabalProcess = runCabalProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FiYWwtcHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9jYWJhbC1wcm9jZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwrQ0FBOEM7QUFDOUMscUNBQTRCO0FBQzVCLDZCQUE0QjtBQUM1QiwyQkFBc0I7QUFHdEIsK0JBQXFDO0FBV3JDO0lBS0UsWUFBYSxPQUFlLEVBQUUsSUFBYyxFQUFFLE9BQW1DLEVBQVUsTUFBZTtRQUFmLFdBQU0sR0FBTixNQUFNLENBQVM7UUFDeEcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLGdCQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQTtRQU1uQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQTtRQUNyQixNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFFeEQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxZQUF1QztZQUN2RCxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUE7WUFDZixNQUFNLENBQUMsQ0FBQyxJQUFZO2dCQUNsQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNwQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFHLENBQUMsQ0FBQTtnQkFHMUMsTUFBTSxJQUFJLEtBQUssQ0FBQTtnQkFDZixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFD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YTs7UUFFbkYsTUFBTSxPQUFPLHFCQUFnQixJQUFJLENBQUMsQ0FBQTtRQUNsQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQXdDLENBQUMsT0FBTztZQUNoRSxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQTtZQUV4QixJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUNuRCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FBQTtBQVRELDBDQVNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2hpbGRfcHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHtraWxsfSBmcm9tICdwcm9jZXNzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHtFT0x9IGZyb20gJ29zJ1xuXG4vLyAvLyBBdG9tIGRlcGVuZGVuY2llc1xuaW1wb3J0IHtEaXJlY3RvcnksIFBvaW50fSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbXMge1xuICBvbk1zZz86IChtc2c6IFVQSS5JUmVzdWx0SXRlbSkgPT4gdm9pZFxuICBvblByb2dyZXNzPzogKHByb2dyZXNzOiBudW1iZXIpID0+IHZvaWRcbiAgb25Eb25lPzogKGRvbmU6IHtleGl0Q29kZTogbnVtYmVyLCBoYXNFcnJvcjogYm9vbGVhbn0pID0+IHZvaWRcbiAgc2V0Q2FuY2VsQWN0aW9uPzogKGFjdGlvbjogKCkgPT4gdm9pZCkgPT4gdm9pZFxuICBzZXZlcml0eTogVVBJLlRTZXZlcml0eVxuICBzZXZlcml0eUNoYW5nZVJ4PzogeyBbSyBpbiBVUEkuVFNldmVyaXR5XTogUmVnRXhwIH1cbn1cblxuY2xhc3MgQ2FiYWxQcm9jZXNzIHtcbiAgcHJpdmF0ZSBjd2Q6IERpcmVjdG9yeVxuICBwcml2YXRlIHJ1bm5pbmc6IGJvb2xlYW5cbiAgcHJpdmF0ZSBoYXNFcnJvcjogYm9vbGVhblxuXG4gIGNvbnN0cnVjdG9yIChjb21tYW5kOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdLCBvcHRpb25zOiBjaGlsZF9wcm9jZXNzLlNwYXduT3B0aW9ucywgcHJpdmF0ZSBwYXJhbXM6IElQYXJhbXMpIHtcbiAgICB0aGlzLmN3ZCA9IG5ldyBEaXJlY3Rvcnkob3B0aW9ucy5jd2QgfHwgJy4nKVxuICAgIHRoaXMucnVubmluZyA9IHRydWVcbiAgICAvLyBjYWJhbCByZXR1cm5zIGZhaWx1cmUgd2hlbiB0aGVyZSBhcmUgdHlwZSBlcnJvcnMgX29yXyB3aGVuIGl0IGNhbid0XG4gICAgLy8gY29tcGlsZSB0aGUgY29kZSBhdCBhbGwgKGkuZS4sIHdoZW4gdGhlcmUgYXJlIG1pc3NpbmcgZGVwZW5kZW5jaWVzKS5cbiAgICAvLyBTaW5jZSBpdCdzIGhhcmQgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiB0aGVzZSB0d28sIHdlIGxvb2sgYXQgdGhlXG4gICAgLy8gcGFyc2VkIGVycm9ycztcbiAgICAvLyB0aGlzLmhhc0Vycm9yIGlzIHNldCBpZiB3ZSBmaW5kIGFuIGVycm9yL3dhcm5pbmcsIHNlZSBwYXJzZU1lc3NhZ2VcbiAgICB0aGlzLmhhc0Vycm9yID0gZmFsc2VcbiAgICBjb25zdCBwcm9jID0gY2hpbGRfcHJvY2Vzcy5zcGF3bihjb21tYW5kLCBhcmdzLCBvcHRpb25zKVxuXG4gICAgY29uc3QgYnVmZmVyZWQgPSAoaGFuZGxlT3V0cHV0OiAobGluZXM6IHN0cmluZ1tdKSA9PiB2b2lkKSA9PiB7XG4gICAgICBsZXQgYnVmZmVyID0gJydcbiAgICAgIHJldHVybiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IG91dHB1dCA9IGRhdGEudG9TdHJpbmcoJ3V0ZjgnKVxuICAgICAgICBjb25zdCBbZmlyc3QsIC4uLnRhaWxdID0gb3V0cHV0LnNwbGl0KEVPTClcbiAgICAgICAgLy8gXiBUaGUgb25seSBwbGFjZSB3aGVyZSB3ZSBnZXQgb3Mtc3BlY2lmaWMgRU9MIChDUi9DUkxGL0xGKVxuICAgICAgICAvLyBpbiB0aGUgcmVzdCBvZiB0aGUgY29kZSB3ZSdyZSB1c2luZyBqdXN0IExGIChcXG4pXG4gICAgICAgIGJ1ZmZlciArPSBmaXJzdFxuICAgICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7IC8vIGl0IG1lYW5zIHRoZXJlJ3MgYXQgbGVhc3Qgb25lIG5ld2xpbmVcbiAgICAgICAgICBjb25zdCBsaW5lcyA9IFtidWZmZXIsIC4uLih0YWlsLnNsaWNlKDAsIC0xKSldXG4gICAgICAgICAgYnVmZmVyID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgICBoYW5kbGVPdXRwdXQobGluZXMpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBibG9ja0J1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGJsb2NrOiBzdHJpbmcpID0+IHZvaWQpID0+IHtcbiAgICAgIC8vIFN0YXJ0IG9mIGEgQ2FiYWwgbWVzc2FnZVxuICAgICAgY29uc3Qgc3RhcnRPZk1lc3NhZ2UgPSAvXFxuKD89XFxTKS9nXG4gICAgICBsZXQgYnVmZmVyOiBzdHJpbmdbXSA9IFtdXG4gICAgICBwcm9jLm9uKCdjbG9zZScsICgpID0+IGhhbmRsZU91dHB1dChidWZmZXIuam9pbignXFxuJykpKVxuICAgICAgcmV0dXJuIGJ1ZmZlcmVkKChsaW5lczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgYnVmZmVyLnB1c2goLi4ubGluZXMpXG4gICAgICAgIC8vIENvdWxkIGl0ZXJhdGUgb3ZlciBsaW5lcyBoZXJlLCBidXQgdGhpcyBpcyBlYXNpZXIsIGlmIG5vdCBhcyBlZmZlY3RpdmVcbiAgICAgICAgY29uc3QgW2ZpcnN0LCAuLi50YWlsXSA9IGJ1ZmZlci5qb2luKCdcXG4nKS5zcGxpdChzdGFydE9mTWVzc2FnZSlcbiAgICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGxhc3QgPSB0YWlsLnNsaWNlKC0xKVswXVxuICAgICAgICAgIGJ1ZmZlciA9IGxhc3Quc3BsaXQoJ1xcbicpXG4gICAgICAgICAgZm9yIChjb25zdCBibG9jayBvZiBbZmlyc3QsIC4uLih0YWlsLnNsaWNlKDAsIC0xKSldKSB7XG4gICAgICAgICAgICBoYW5kbGVPdXRwdXQoYmxvY2spXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5zZXRDYW5jZWxBY3Rpb24pIHtcbiAgICAgIHRoaXMucGFyYW1zLnNldENhbmNlbEFjdGlvbigoKSA9PiB7XG4gICAgICAgIHRyeSB7IGtpbGwoLXByb2MucGlkKSB9IGNhdGNoIChlKSB7IC8qbm9vcCovIH1cbiAgICAgICAgdHJ5IHsga2lsbChwcm9jLnBpZCkgfSBjYXRjaCAoZSkgeyAvKm5vb3AqLyB9XG4gICAgICAgIHRyeSB7IHByb2Mua2lsbCgpIH0gY2F0Y2ggKGUpIHsgLypub29wKi8gfVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBoYW5kbGVNZXNzYWdlID0gKG1zZzogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLmNoZWNrUHJvZ3Jlc3MobXNnKVxuICAgICAgdGhpcy5jaGVja1NldmVyaXR5Q2hhbmdlKG1zZylcbiAgICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMucGFyc2VNZXNzYWdlKG1zZylcbiAgICAgIGlmIChwYXJzZWQgJiYgdGhpcy5wYXJhbXMub25Nc2cpIHtcbiAgICAgICAgdGhpcy5wYXJhbXMub25Nc2cocGFyc2VkKVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdGU6IGJsb2NrQnVmZmVyZWQgdXNlZCB0d2ljZSBiZWNhdXNlIHdlIG5lZWQgc2VwYXJhdGUgYnVmZmVyc1xuICAgIC8vIGZvciBzdGRlcnIgYW5kIHN0ZG91dFxuICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgYmxvY2tCdWZmZXJlZChoYW5kbGVNZXNzYWdlKSlcbiAgICBwcm9jLnN0ZGVyci5vbignZGF0YScsIGJsb2NrQnVmZmVyZWQoaGFuZGxlTWVzc2FnZSkpXG5cbiAgICBwcm9jLm9uKCdjbG9zZScsIChleGl0Q29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBpZiAodGhpcy5wYXJhbXMub25Eb25lKSB7IHRoaXMucGFyYW1zLm9uRG9uZSh7ZXhpdENvZGUsIGhhc0Vycm9yOiB0aGlzLmhhc0Vycm9yfSkgfVxuICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2VcbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSB1bmluZGVudE1lc3NhZ2UgKGxpbmVzOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IG1pbkluZGVudCA9IE1hdGgubWluKC4uLihsaW5lcy5tYXAoKGxpbmUpID0+IHtcbiAgICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCgvXlxccyovKVxuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIHJldHVybiBtYXRjaFswXS5sZW5ndGhcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwXG4gICAgICB9XG4gICAgfSkpKVxuICAgIHJldHVybiBsaW5lcy5tYXAoKGxpbmUpID0+IGxpbmUuc2xpY2UobWluSW5kZW50KSkuam9pbignXFxuJylcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VNZXNzYWdlIChyYXc6IHN0cmluZykge1xuICAgIGlmIChyYXcudHJpbSgpICE9PSAnJykge1xuICAgICAgY29uc3QgbWF0Y2hMb2MgPSAvXiguKyk6KFxcZCspOihcXGQrKTooPzogKFxcdyspOik/WyBcXHRdKihcXFtbXlxcXV0rXFxdKT9bIFxcdF0qXFxuPyhbXl0qKS9cbiAgICAgIGNvbnN0IG1hdGNoZWQgPSAocmF3IGFzIGFueSkudHJpbVJpZ2h0KCkubWF0Y2gobWF0Y2hMb2MpXG4gICAgICBpZiAobWF0Y2hlZCkge1xuICAgICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZVxuXG4gICAgICAgIGNvbnN0IFtmaWxlLCBsaW5lLCBjb2wsIHJhd1R5cCwgY29udGV4dCwgbXNnXSA9IG1hdGNoZWQuc2xpY2UoMSlcbiAgICAgICAgY29uc3QgdHlwID0gcmF3VHlwID8gcmF3VHlwLnRvTG93ZXJDYXNlKCkgOiAnZXJyb3InXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB1cmk6IHBhdGguaXNBYnNvbHV0ZShmaWxlKSA/IGZpbGUgOiB0aGlzLmN3ZC5nZXRGaWxlKGZpbGUpLmdldFBhdGgoKSxcbiAgICAgICAgICBwb3NpdGlvbjogbmV3IFBvaW50KHBhcnNlSW50KGxpbmUsIDEwKSAtIDEsIHBhcnNlSW50KGNvbCwgMTApIC0gMSksXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICB0ZXh0OiB0aGlzLnVuaW5kZW50TWVzc2FnZShtc2cuc3BsaXQoJ1xcbicpKSxcbiAgICAgICAgICAgIGhpZ2hsaWdodGVyOiAnaGludC5tZXNzYWdlLmhhc2tlbGwnXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzZXZlcml0eTogdHlwXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWVzc2FnZTogcmF3LFxuICAgICAgICAgIHNldmVyaXR5OiB0aGlzLnBhcmFtcy5zZXZlcml0eVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1NldmVyaXR5Q2hhbmdlIChkYXRhOiBzdHJpbmcpIHtcbiAgICBpZiAoISB0aGlzLnBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSB7IHJldHVybiB9XG4gICAgZm9yIChjb25zdCBbc2V2LCByeF0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5wYXJhbXMuc2V2ZXJpdHlDaGFuZ2VSeCkpIHtcbiAgICAgIGlmIChkYXRhLm1hdGNoKHJ4KSkge1xuICAgICAgICB0aGlzLnBhcmFtcy5zZXZlcml0eSA9IHNldlxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tQcm9ncmVzcyAoZGF0YTogc3RyaW5nKSB7XG4gICAgY29uc3QgbWF0Y2ggPSBkYXRhLm1hdGNoKC9cXFtcXHMqKFtcXGRdKylcXHMrb2ZcXHMrKFtcXGRdKylcXHMqXFxdLylcbiAgICBpZiAobWF0Y2gpIHtcbiAgICAgIGNvbnN0IHByb2dyZXNzID0gbWF0Y2hbMV0sIHRvdGFsID0gbWF0Y2hbMl1cbiAgICAgIHRoaXMucGFyYW1zLm9uUHJvZ3Jlc3MgJiYgdGhpcy5wYXJhbXMub25Qcm9ncmVzcyhwYXJzZUludChwcm9ncmVzcywgMTApIC8gcGFyc2VJbnQodG90YWwsIDEwKSlcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJ1bkNhYmFsUHJvY2VzcyAoXG4gIGNvbW1hbmQ6IHN0cmluZywgYXJnczogc3RyaW5nW10sIG9wdGlvbnM6IGNoaWxkX3Byb2Nlc3MuU3Bhd25PcHRpb25zLCBwYXJzOiBJUGFyYW1zXG4pIHtcbiAgY29uc3QgbmV3UGFyczogSVBhcmFtcyA9IHsuLi5wYXJzfVxuICByZXR1cm4gbmV3IFByb21pc2U8e2V4aXRDb2RlOiBudW1iZXIsIGhhc0Vycm9yOiBib29sZWFufT4oKHJlc29sdmUpID0+IHtcbiAgICBuZXdQYXJzLm9uRG9uZSA9IHJlc29sdmVcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLXVudXNlZC1leHByZXNzaW9uXG4gICAgbmV3IENhYmFsUHJvY2Vzcyhjb21tYW5kLCBhcmdzLCBvcHRpb25zLCBuZXdQYXJzKVxuICB9KVxufVxuIl19