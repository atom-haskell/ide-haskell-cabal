"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
class CabalProcess {
    constructor(command, args, options, params) {
        this.params = params;
        this.cwd = new atom_1.Directory(options.cwd || '.');
        this.running = true;
        this.hasError = false;
        const proc = child_process.spawn(command, args, options);
        const buffered = (handleOutput) => {
            let buffer = '';
            return (data) => {
                const output = data.toString('utf8');
                const [first, ...tail] = output.split(os_1.EOL);
                buffer += first;
                if (tail.length > 0) {
                    const lines = [buffer, ...(tail.slice(0, -1))];
                    buffer = tail.slice(-1)[0];
                    handleOutput(lines);
                }
            };
        };
        const blockBuffered = (handleOutput) => {
            const startOfMessage = /\n(?=\S)/g;
            let buffer = [];
            proc.on('close', () => handleOutput(buffer.join('\n')));
            return buffered((lines) => {
                buffer.push(...lines);
                const [first, ...tail] = buffer.join('\n').split(startOfMessage);
                if (tail.length > 0) {
                    const last = tail.slice(-1)[0];
                    buffer = last.split('\n');
                    for (const block of [first, ...(tail.slice(0, -1))]) {
                        handleOutput(block);
                    }
                }
            });
        };
        if (this.params.setCancelAction) {
            this.params.setCancelAction(() => {
                try {
                    process_1.kill(-proc.pid);
                }
                catch (e) { }
                try {
                    process_1.kill(proc.pid);
                }
                catch (e) { }
                try {
                    proc.kill();
                }
                catch (e) { }
            });
        }
        const handleMessage = (msg) => {
            this.checkProgress(msg);
            this.checkSeverityChange(msg);
            const parsed = this.parseMessage(msg);
            if (parsed && this.params.onMsg) {
                this.params.onMsg(parsed);
            }
        };
        proc.stdout.on('data', blockBuffered(handleMessage));
        proc.stderr.on('data', blockBuffered(handleMessage));
        proc.on('close', (exitCode, signal) => {
            if (this.params.onDone) {
                this.params.onDone({ exitCode, hasError: this.hasError });
            }
            this.running = false;
        });
    }
    unindentMessage(lines) {
        const minIndent = Math.min(...(lines.map((line) => {
            const match = line.match(/^\s*/);
            if (match) {
                return match[0].length;
            }
            else {
                return 0;
            }
        })));
        return lines.map((line) => line.slice(minIndent)).join('\n');
    }
    parseMessage(raw) {
        if (raw.trim() !== '') {
            const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
            const matched = raw.trimRight().match(matchLoc);
            if (matched) {
                this.hasError = true;
                const [file, line, col, rawTyp, context, msg] = matched.slice(1);
                const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
                return {
                    uri: path.isAbsolute(file) ? file : this.cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: this.unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell'
                    },
                    severity: typ
                };
            }
            else {
                return {
                    message: raw,
                    severity: this.params.severity
                };
            }
        }
    }
    checkSeverityChange(data) {
        if (!this.params.severityChangeRx) {
            return;
        }
        for (const [sev, rx] of Object.entries(this.params.severityChangeRx)) {
            if (data.match(rx)) {
                this.params.severity = sev;
                break;
            }
        }
    }
    checkProgress(data) {
        const match = data.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
        if (match) {
            const progress = match[1], total = match[2];
            this.params.onProgress && this.params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
        }
    }
}
function runCabalProcess(command, args, options, pars) {
    return __awaiter(this, void 0, void 0, function* () {
        const newPars = Object.assign({}, pars);
        return new Promise((resolve) => {
            newPars.onDone = resolve;
            new CabalProcess(command, args, options, newPars);
        });
    });
}
exports.runCabalProcess = runCabalProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FiYWwtcHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9jYWJhbC1wcm9jZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwrQ0FBOEM7QUFDOUMscUNBQTRCO0FBQzVCLDZCQUE0QjtBQUM1QiwyQkFBc0I7QUFHdEIsK0JBQXFDO0FBV3JDO0lBS0UsWUFBYSxPQUFlLEVBQUUsSUFBYyxFQUFFLE9BQW1DLEVBQVUsTUFBZTtRQUFmLFdBQU0sR0FBTixNQUFNLENBQVM7UUFDeEcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLGdCQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQTtRQU1uQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQTtRQUNyQixNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFFeEQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxZQUF1QztZQUN2RCxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUE7WUFDZixNQUFNLENBQUMsQ0FBQyxJQUFZO2dCQUNsQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNwQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFHLENBQUMsQ0FBQTtnQkFHMUMsTUFBTSxJQUFJLEtBQUssQ0FBQTtnQkFDZixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFD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YTs7UUFFbkYsTUFBTSxPQUFPLHFCQUFnQixJQUFJLENBQUMsQ0FBQTtRQUNsQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQXdDLENBQUMsT0FBTztZQUNoRSxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQTtZQUV4QixJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUNuRCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FBQTtBQVRELDBDQVNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2hpbGRfcHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHtraWxsfSBmcm9tICdwcm9jZXNzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHtFT0x9IGZyb20gJ29zJ1xuXG4vLyAvLyBBdG9tIGRlcGVuZGVuY2llc1xuaW1wb3J0IHtEaXJlY3RvcnksIFBvaW50fSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbXMge1xuICBvbk1zZz86IChtc2c6IFVQSS5JUmVzdWx0SXRlbSkgPT4gdm9pZFxuICBvblByb2dyZXNzPzogKHByb2dyZXNzOiBudW1iZXIpID0+IHZvaWRcbiAgb25Eb25lPzogKGRvbmU6IHtleGl0Q29kZTogbnVtYmVyLCBoYXNFcnJvcjogYm9vbGVhbn0pID0+IHZvaWRcbiAgc2V0Q2FuY2VsQWN0aW9uPzogKGFjdGlvbjogKCkgPT4gdm9pZCkgPT4gdm9pZFxuICBzZXZlcml0eTogVVBJLlRTZXZlcml0eVxuICBzZXZlcml0eUNoYW5nZVJ4PzogUmVnRXhwXG59XG5cbmNsYXNzIENhYmFsUHJvY2VzcyB7XG4gIHByaXZhdGUgY3dkOiBEaXJlY3RvcnlcbiAgcHJpdmF0ZSBydW5uaW5nOiBib29sZWFuXG4gIHByaXZhdGUgaGFzRXJyb3I6IGJvb2xlYW5cblxuICBjb25zdHJ1Y3RvciAoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSwgb3B0aW9uczogY2hpbGRfcHJvY2Vzcy5TcGF3bk9wdGlvbnMsIHByaXZhdGUgcGFyYW1zOiBJUGFyYW1zKSB7XG4gICAgdGhpcy5jd2QgPSBuZXcgRGlyZWN0b3J5KG9wdGlvbnMuY3dkIHx8ICcuJylcbiAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlXG4gICAgLy8gY2FiYWwgcmV0dXJucyBmYWlsdXJlIHdoZW4gdGhlcmUgYXJlIHR5cGUgZXJyb3JzIF9vcl8gd2hlbiBpdCBjYW4ndFxuICAgIC8vIGNvbXBpbGUgdGhlIGNvZGUgYXQgYWxsIChpLmUuLCB3aGVuIHRoZXJlIGFyZSBtaXNzaW5nIGRlcGVuZGVuY2llcykuXG4gICAgLy8gU2luY2UgaXQncyBoYXJkIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gdGhlc2UgdHdvLCB3ZSBsb29rIGF0IHRoZVxuICAgIC8vIHBhcnNlZCBlcnJvcnM7XG4gICAgLy8gdGhpcy5oYXNFcnJvciBpcyBzZXQgaWYgd2UgZmluZCBhbiBlcnJvci93YXJuaW5nLCBzZWUgcGFyc2VNZXNzYWdlXG4gICAgdGhpcy5oYXNFcnJvciA9IGZhbHNlXG4gICAgY29uc3QgcHJvYyA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oY29tbWFuZCwgYXJncywgb3B0aW9ucylcblxuICAgIGNvbnN0IGJ1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGxpbmVzOiBzdHJpbmdbXSkgPT4gdm9pZCkgPT4ge1xuICAgICAgbGV0IGJ1ZmZlciA9ICcnXG4gICAgICByZXR1cm4gKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICAgICAgICBjb25zdCBvdXRwdXQgPSBkYXRhLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgICAgY29uc3QgW2ZpcnN0LCAuLi50YWlsXSA9IG91dHB1dC5zcGxpdChFT0wpXG4gICAgICAgIC8vIF4gVGhlIG9ubHkgcGxhY2Ugd2hlcmUgd2UgZ2V0IG9zLXNwZWNpZmljIEVPTCAoQ1IvQ1JMRi9MRilcbiAgICAgICAgLy8gaW4gdGhlIHJlc3Qgb2YgdGhlIGNvZGUgd2UncmUgdXNpbmcganVzdCBMRiAoXFxuKVxuICAgICAgICBidWZmZXIgKz0gZmlyc3RcbiAgICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkgeyAvLyBpdCBtZWFucyB0aGVyZSdzIGF0IGxlYXN0IG9uZSBuZXdsaW5lXG4gICAgICAgICAgY29uc3QgbGluZXMgPSBbYnVmZmVyLCAuLi4odGFpbC5zbGljZSgwLCAtMSkpXVxuICAgICAgICAgIGJ1ZmZlciA9IHRhaWwuc2xpY2UoLTEpWzBdXG4gICAgICAgICAgaGFuZGxlT3V0cHV0KGxpbmVzKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYmxvY2tCdWZmZXJlZCA9IChoYW5kbGVPdXRwdXQ6IChibG9jazogc3RyaW5nKSA9PiB2b2lkKSA9PiB7XG4gICAgICAvLyBTdGFydCBvZiBhIENhYmFsIG1lc3NhZ2VcbiAgICAgIGNvbnN0IHN0YXJ0T2ZNZXNzYWdlID0gL1xcbig/PVxcUykvZ1xuICAgICAgbGV0IGJ1ZmZlcjogc3RyaW5nW10gPSBbXVxuICAgICAgcHJvYy5vbignY2xvc2UnLCAoKSA9PiBoYW5kbGVPdXRwdXQoYnVmZmVyLmpvaW4oJ1xcbicpKSlcbiAgICAgIHJldHVybiBidWZmZXJlZCgobGluZXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIGJ1ZmZlci5wdXNoKC4uLmxpbmVzKVxuICAgICAgICAvLyBDb3VsZCBpdGVyYXRlIG92ZXIgbGluZXMgaGVyZSwgYnV0IHRoaXMgaXMgZWFzaWVyLCBpZiBub3QgYXMgZWZmZWN0aXZlXG4gICAgICAgIGNvbnN0IFtmaXJzdCwgLi4udGFpbF0gPSBidWZmZXIuam9pbignXFxuJykuc3BsaXQoc3RhcnRPZk1lc3NhZ2UpXG4gICAgICAgIGlmICh0YWlsLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBsYXN0ID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgICBidWZmZXIgPSBsYXN0LnNwbGl0KCdcXG4nKVxuICAgICAgICAgIGZvciAoY29uc3QgYmxvY2sgb2YgW2ZpcnN0LCAuLi4odGFpbC5zbGljZSgwLCAtMSkpXSkge1xuICAgICAgICAgICAgaGFuZGxlT3V0cHV0KGJsb2NrKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJhbXMuc2V0Q2FuY2VsQWN0aW9uKSB7XG4gICAgICB0aGlzLnBhcmFtcy5zZXRDYW5jZWxBY3Rpb24oKCkgPT4ge1xuICAgICAgICB0cnkgeyBraWxsKC1wcm9jLnBpZCkgfSBjYXRjaCAoZSkgeyAvKm5vb3AqLyB9XG4gICAgICAgIHRyeSB7IGtpbGwocHJvYy5waWQpIH0gY2F0Y2ggKGUpIHsgLypub29wKi8gfVxuICAgICAgICB0cnkgeyBwcm9jLmtpbGwoKSB9IGNhdGNoIChlKSB7IC8qbm9vcCovIH1cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgaGFuZGxlTWVzc2FnZSA9IChtc2c6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5jaGVja1Byb2dyZXNzKG1zZylcbiAgICAgIHRoaXMuY2hlY2tTZXZlcml0eUNoYW5nZShtc2cpXG4gICAgICBjb25zdCBwYXJzZWQgPSB0aGlzLnBhcnNlTWVzc2FnZShtc2cpXG4gICAgICBpZiAocGFyc2VkICYmIHRoaXMucGFyYW1zLm9uTXNnKSB7XG4gICAgICAgIHRoaXMucGFyYW1zLm9uTXNnKHBhcnNlZClcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBOb3RlOiBibG9ja0J1ZmZlcmVkIHVzZWQgdHdpY2UgYmVjYXVzZSB3ZSBuZWVkIHNlcGFyYXRlIGJ1ZmZlcnNcbiAgICAvLyBmb3Igc3RkZXJyIGFuZCBzdGRvdXRcbiAgICBwcm9jLnN0ZG91dC5vbignZGF0YScsIGJsb2NrQnVmZmVyZWQoaGFuZGxlTWVzc2FnZSkpXG4gICAgcHJvYy5zdGRlcnIub24oJ2RhdGEnLCBibG9ja0J1ZmZlcmVkKGhhbmRsZU1lc3NhZ2UpKVxuXG4gICAgcHJvYy5vbignY2xvc2UnLCAoZXhpdENvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgaWYgKHRoaXMucGFyYW1zLm9uRG9uZSkgeyB0aGlzLnBhcmFtcy5vbkRvbmUoe2V4aXRDb2RlLCBoYXNFcnJvcjogdGhpcy5oYXNFcnJvcn0pIH1cbiAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlXG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgdW5pbmRlbnRNZXNzYWdlIChsaW5lczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBtaW5JbmRlbnQgPSBNYXRoLm1pbiguLi4obGluZXMubWFwKChsaW5lKSA9PiB7XG4gICAgICBjb25zdCBtYXRjaCA9IGxpbmUubWF0Y2goL15cXHMqLylcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICByZXR1cm4gbWF0Y2hbMF0ubGVuZ3RoXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gMFxuICAgICAgfVxuICAgIH0pKSlcbiAgICByZXR1cm4gbGluZXMubWFwKChsaW5lKSA9PiBsaW5lLnNsaWNlKG1pbkluZGVudCkpLmpvaW4oJ1xcbicpXG4gIH1cblxuICBwcml2YXRlIHBhcnNlTWVzc2FnZSAocmF3OiBzdHJpbmcpIHtcbiAgICBpZiAocmF3LnRyaW0oKSAhPT0gJycpIHtcbiAgICAgIGNvbnN0IG1hdGNoTG9jID0gL14oLispOihcXGQrKTooXFxkKyk6KD86IChcXHcrKTopP1sgXFx0XSooXFxbW15cXF1dK1xcXSk/WyBcXHRdKlxcbj8oW15dKikvXG4gICAgICBjb25zdCBtYXRjaGVkID0gKHJhdyBhcyBhbnkpLnRyaW1SaWdodCgpLm1hdGNoKG1hdGNoTG9jKVxuICAgICAgaWYgKG1hdGNoZWQpIHtcbiAgICAgICAgdGhpcy5oYXNFcnJvciA9IHRydWVcblxuICAgICAgICBjb25zdCBbZmlsZSwgbGluZSwgY29sLCByYXdUeXAsIGNvbnRleHQsIG1zZ10gPSBtYXRjaGVkLnNsaWNlKDEpXG4gICAgICAgIGNvbnN0IHR5cCA9IHJhd1R5cCA/IHJhd1R5cC50b0xvd2VyQ2FzZSgpIDogJ2Vycm9yJ1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdXJpOiBwYXRoLmlzQWJzb2x1dGUoZmlsZSkgPyBmaWxlIDogdGhpcy5jd2QuZ2V0RmlsZShmaWxlKS5nZXRQYXRoKCksXG4gICAgICAgICAgcG9zaXRpb246IG5ldyBQb2ludChwYXJzZUludChsaW5lLCAxMCkgLSAxLCBwYXJzZUludChjb2wsIDEwKSAtIDEpLFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgICAgdGV4dDogdGhpcy51bmluZGVudE1lc3NhZ2UobXNnLnNwbGl0KCdcXG4nKSksXG4gICAgICAgICAgICBoaWdobGlnaHRlcjogJ2hpbnQubWVzc2FnZS5oYXNrZWxsJ1xuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V2ZXJpdHk6IHR5cFxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1lc3NhZ2U6IHJhdyxcbiAgICAgICAgICBzZXZlcml0eTogdGhpcy5wYXJhbXMuc2V2ZXJpdHlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tTZXZlcml0eUNoYW5nZSAoZGF0YTogc3RyaW5nKSB7XG4gICAgaWYgKCEgdGhpcy5wYXJhbXMuc2V2ZXJpdHlDaGFuZ2VSeCkgeyByZXR1cm4gfVxuICAgIGZvciAoY29uc3QgW3NldiwgcnhdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMucGFyYW1zLnNldmVyaXR5Q2hhbmdlUngpKSB7XG4gICAgICBpZiAoZGF0YS5tYXRjaChyeCkpIHtcbiAgICAgICAgdGhpcy5wYXJhbXMuc2V2ZXJpdHkgPSBzZXZcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrUHJvZ3Jlc3MgKGRhdGE6IHN0cmluZykge1xuICAgIGNvbnN0IG1hdGNoID0gZGF0YS5tYXRjaCgvXFxbXFxzKihbXFxkXSspXFxzK29mXFxzKyhbXFxkXSspXFxzKlxcXS8pXG4gICAgaWYgKG1hdGNoKSB7XG4gICAgICBjb25zdCBwcm9ncmVzcyA9IG1hdGNoWzFdLCB0b3RhbCA9IG1hdGNoWzJdXG4gICAgICB0aGlzLnBhcmFtcy5vblByb2dyZXNzICYmIHRoaXMucGFyYW1zLm9uUHJvZ3Jlc3MocGFyc2VJbnQocHJvZ3Jlc3MsIDEwKSAvIHBhcnNlSW50KHRvdGFsLCAxMCkpXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5DYWJhbFByb2Nlc3MgKFxuICBjb21tYW5kOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdLCBvcHRpb25zOiBjaGlsZF9wcm9jZXNzLlNwYXduT3B0aW9ucywgcGFyczogSVBhcmFtc1xuKSB7XG4gIGNvbnN0IG5ld1BhcnM6IElQYXJhbXMgPSB7Li4ucGFyc31cbiAgcmV0dXJuIG5ldyBQcm9taXNlPHtleGl0Q29kZTogbnVtYmVyLCBoYXNFcnJvcjogYm9vbGVhbn0+KChyZXNvbHZlKSA9PiB7XG4gICAgbmV3UGFycy5vbkRvbmUgPSByZXNvbHZlXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11bnVzZWQtZXhwcmVzc2lvblxuICAgIG5ldyBDYWJhbFByb2Nlc3MoY29tbWFuZCwgYXJncywgb3B0aW9ucywgbmV3UGFycylcbiAgfSlcbn1cbiJdfQ==