"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
class CabalProcess {
    constructor(command, args, options, params) {
        this.params = params;
        this.cwd = new atom_1.Directory(options.cwd || '.');
        this.hasError = false;
        const proc = child_process.spawn(command, args, options);
        const buffered = (handleOutput) => {
            let buffer = '';
            return (data) => {
                const output = data.toString('utf8');
                const [first, ...tail] = output.split(os_1.EOL);
                buffer += first;
                if (tail.length > 0) {
                    const lines = [buffer, ...(tail.slice(0, -1))];
                    buffer = tail.slice(-1)[0];
                    handleOutput(lines);
                }
            };
        };
        const blockBuffered = (handleOutput) => {
            const startOfMessage = /\n(?=\S)/g;
            let buffer = [];
            proc.on('close', () => handleOutput(buffer.join('\n')));
            return buffered((lines) => {
                buffer.push(...lines);
                const [first, ...tail] = buffer.join('\n').split(startOfMessage);
                if (tail.length > 0) {
                    const last = tail.slice(-1)[0];
                    buffer = last.split('\n');
                    for (const block of [first, ...(tail.slice(0, -1))]) {
                        handleOutput(block);
                    }
                }
            });
        };
        if (this.params.setCancelAction) {
            this.params.setCancelAction(() => {
                try {
                    process_1.kill(-proc.pid);
                }
                catch (e) { }
                try {
                    process_1.kill(proc.pid);
                }
                catch (e) { }
                try {
                    proc.kill();
                }
                catch (e) { }
            });
        }
        const handleMessage = (msg) => {
            this.checkProgress(msg);
            this.checkSeverityChange(msg);
            const parsed = this.parseMessage(msg);
            if (parsed && this.params.onMsg) {
                this.params.onMsg(parsed);
            }
        };
        proc.stdout.on('data', blockBuffered(handleMessage));
        proc.stderr.on('data', blockBuffered(handleMessage));
        proc.on('close', (exitCode) => {
            if (this.params.onDone) {
                this.params.onDone({ exitCode, hasError: this.hasError });
            }
        });
    }
    unindentMessage(lines) {
        const minIndent = Math.min(...(lines.map((line) => {
            const match = line.match(/^\s*/);
            if (match) {
                return match[0].length;
            }
            else {
                return 0;
            }
        })));
        return lines.map((line) => line.slice(minIndent)).join('\n');
    }
    parseMessage(raw) {
        if (raw.trim() !== '') {
            const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
            const matched = raw.trimRight().match(matchLoc);
            if (matched) {
                this.hasError = true;
                const [file, line, col, rawTyp, context, msg] = matched.slice(1);
                const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
                return {
                    uri: path.isAbsolute(file) ? file : this.cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: this.unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell',
                    },
                    severity: typ,
                };
            }
            else {
                return {
                    message: raw,
                    severity: this.params.severity,
                };
            }
        }
        return undefined;
    }
    checkSeverityChange(data) {
        if (!this.params.severityChangeRx) {
            return;
        }
        for (const [sev, rx] of Object.entries(this.params.severityChangeRx)) {
            if (data.match(rx)) {
                this.params.severity = sev;
                break;
            }
        }
    }
    checkProgress(data) {
        const match = data.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
        if (match) {
            const progress = match[1];
            const total = match[2];
            this.params.onProgress && this.params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
        }
    }
}
async function runCabalProcess(command, args, options, pars) {
    const newPars = Object.assign({}, pars);
    return new Promise((resolve) => {
        newPars.onDone = resolve;
        new CabalProcess(command, args, options, newPars);
    });
}
exports.runCabalProcess = runCabalProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FiYWwtcHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9jYWJhbC1wcm9jZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0NBQThDO0FBQzlDLHFDQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIsMkJBQXdCO0FBSXhCLCtCQUF1QztBQVd2QztJQUlFLFlBQVksT0FBZSxFQUFFLElBQWMsRUFBRSxPQUFtQyxFQUFVLE1BQWU7UUFBZixXQUFNLEdBQU4sTUFBTSxDQUFTO1FBQ3ZHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxnQkFBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUE7UUFNNUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUE7UUFDckIsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBRXhELE1BQU0sUUFBUSxHQUFHLENBQUMsWUFBdUMsRUFBRSxFQUFFO1lBQzNELElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtZQUNmLE1BQU0sQ0FBQyxDQUFDLElBQVksRUFBRSxFQUFFO2dCQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNwQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFHLENBQUMsQ0FBQTtnQkFHMUMsTUFBTSxJQUFJLEtBQUssQ0FBQTtnQkFDZixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLE1BQU0sS0FBSyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FB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LENBQUMsQ0FBQyxDQUFBO1FBQ2hHLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFFTSxLQUFLLDBCQUNWLE9BQWUsRUFBRSxJQUFjLEVBQUUsT0FBbUMsRUFBRSxJQUFhO0lBRW5GLE1BQU0sT0FBTyxxQkFBaUIsSUFBSSxDQUFFLENBQUE7SUFDcEMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUEwQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3RFLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFBO1FBRXhCLElBQUksWUFBWSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBQ25ELENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQVRELDBDQVNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2hpbGRfcHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHsga2lsbCB9IGZyb20gJ3Byb2Nlc3MnXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuXG4vLyAvLyBBdG9tIGRlcGVuZGVuY2llc1xuaW1wb3J0IHsgRGlyZWN0b3J5LCBQb2ludCB9IGZyb20gJ2F0b20nXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBhcmFtcyB7XG4gIG9uTXNnPzogKG1zZzogVVBJLklSZXN1bHRJdGVtKSA9PiB2b2lkXG4gIG9uUHJvZ3Jlc3M/OiAocHJvZ3Jlc3M6IG51bWJlcikgPT4gdm9pZFxuICBvbkRvbmU/OiAoZG9uZTogeyBleGl0Q29kZTogbnVtYmVyLCBoYXNFcnJvcjogYm9vbGVhbiB9KSA9PiB2b2lkXG4gIHNldENhbmNlbEFjdGlvbj86IChhY3Rpb246ICgpID0+IHZvaWQpID0+IHZvaWRcbiAgc2V2ZXJpdHk6IFVQSS5UU2V2ZXJpdHlcbiAgc2V2ZXJpdHlDaGFuZ2VSeD86IHtbSyBpbiBVUEkuVFNldmVyaXR5XTogUmVnRXhwIH1cbn1cblxuY2xhc3MgQ2FiYWxQcm9jZXNzIHtcbiAgcHJpdmF0ZSBjd2Q6IERpcmVjdG9yeVxuICBwcml2YXRlIGhhc0Vycm9yOiBib29sZWFuXG5cbiAgY29uc3RydWN0b3IoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSwgb3B0aW9uczogY2hpbGRfcHJvY2Vzcy5TcGF3bk9wdGlvbnMsIHByaXZhdGUgcGFyYW1zOiBJUGFyYW1zKSB7XG4gICAgdGhpcy5jd2QgPSBuZXcgRGlyZWN0b3J5KG9wdGlvbnMuY3dkIHx8ICcuJylcbiAgICAvLyBjYWJhbCByZXR1cm5zIGZhaWx1cmUgd2hlbiB0aGVyZSBhcmUgdHlwZSBlcnJvcnMgX29yXyB3aGVuIGl0IGNhbid0XG4gICAgLy8gY29tcGlsZSB0aGUgY29kZSBhdCBhbGwgKGkuZS4sIHdoZW4gdGhlcmUgYXJlIG1pc3NpbmcgZGVwZW5kZW5jaWVzKS5cbiAgICAvLyBTaW5jZSBpdCdzIGhhcmQgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiB0aGVzZSB0d28sIHdlIGxvb2sgYXQgdGhlXG4gICAgLy8gcGFyc2VkIGVycm9ycztcbiAgICAvLyB0aGlzLmhhc0Vycm9yIGlzIHNldCBpZiB3ZSBmaW5kIGFuIGVycm9yL3dhcm5pbmcsIHNlZSBwYXJzZU1lc3NhZ2VcbiAgICB0aGlzLmhhc0Vycm9yID0gZmFsc2VcbiAgICBjb25zdCBwcm9jID0gY2hpbGRfcHJvY2Vzcy5zcGF3bihjb21tYW5kLCBhcmdzLCBvcHRpb25zKVxuXG4gICAgY29uc3QgYnVmZmVyZWQgPSAoaGFuZGxlT3V0cHV0OiAobGluZXM6IHN0cmluZ1tdKSA9PiB2b2lkKSA9PiB7XG4gICAgICBsZXQgYnVmZmVyID0gJydcbiAgICAgIHJldHVybiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IG91dHB1dCA9IGRhdGEudG9TdHJpbmcoJ3V0ZjgnKVxuICAgICAgICBjb25zdCBbZmlyc3QsIC4uLnRhaWxdID0gb3V0cHV0LnNwbGl0KEVPTClcbiAgICAgICAgLy8gXiBUaGUgb25seSBwbGFjZSB3aGVyZSB3ZSBnZXQgb3Mtc3BlY2lmaWMgRU9MIChDUi9DUkxGL0xGKVxuICAgICAgICAvLyBpbiB0aGUgcmVzdCBvZiB0aGUgY29kZSB3ZSdyZSB1c2luZyBqdXN0IExGIChcXG4pXG4gICAgICAgIGJ1ZmZlciArPSBmaXJzdFxuICAgICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7IC8vIGl0IG1lYW5zIHRoZXJlJ3MgYXQgbGVhc3Qgb25lIG5ld2xpbmVcbiAgICAgICAgICBjb25zdCBsaW5lcyA9IFtidWZmZXIsIC4uLih0YWlsLnNsaWNlKDAsIC0xKSldXG4gICAgICAgICAgYnVmZmVyID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgICBoYW5kbGVPdXRwdXQobGluZXMpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBibG9ja0J1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGJsb2NrOiBzdHJpbmcpID0+IHZvaWQpID0+IHtcbiAgICAgIC8vIFN0YXJ0IG9mIGEgQ2FiYWwgbWVzc2FnZVxuICAgICAgY29uc3Qgc3RhcnRPZk1lc3NhZ2UgPSAvXFxuKD89XFxTKS9nXG4gICAgICBsZXQgYnVmZmVyOiBzdHJpbmdbXSA9IFtdXG4gICAgICBwcm9jLm9uKCdjbG9zZScsICgpID0+IGhhbmRsZU91dHB1dChidWZmZXIuam9pbignXFxuJykpKVxuICAgICAgcmV0dXJuIGJ1ZmZlcmVkKChsaW5lczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgYnVmZmVyLnB1c2goLi4ubGluZXMpXG4gICAgICAgIC8vIENvdWxkIGl0ZXJhdGUgb3ZlciBsaW5lcyBoZXJlLCBidXQgdGhpcyBpcyBlYXNpZXIsIGlmIG5vdCBhcyBlZmZlY3RpdmVcbiAgICAgICAgY29uc3QgW2ZpcnN0LCAuLi50YWlsXSA9IGJ1ZmZlci5qb2luKCdcXG4nKS5zcGxpdChzdGFydE9mTWVzc2FnZSlcbiAgICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGxhc3QgPSB0YWlsLnNsaWNlKC0xKVswXVxuICAgICAgICAgIGJ1ZmZlciA9IGxhc3Quc3BsaXQoJ1xcbicpXG4gICAgICAgICAgZm9yIChjb25zdCBibG9jayBvZiBbZmlyc3QsIC4uLih0YWlsLnNsaWNlKDAsIC0xKSldKSB7XG4gICAgICAgICAgICBoYW5kbGVPdXRwdXQoYmxvY2spXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5zZXRDYW5jZWxBY3Rpb24pIHtcbiAgICAgIHRoaXMucGFyYW1zLnNldENhbmNlbEFjdGlvbigoKSA9PiB7XG4gICAgICAgIHRyeSB7IGtpbGwoLXByb2MucGlkKSB9IGNhdGNoIChlKSB7IC8qbm9vcCovIH1cbiAgICAgICAgdHJ5IHsga2lsbChwcm9jLnBpZCkgfSBjYXRjaCAoZSkgeyAvKm5vb3AqLyB9XG4gICAgICAgIHRyeSB7IHByb2Mua2lsbCgpIH0gY2F0Y2ggKGUpIHsgLypub29wKi8gfVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBoYW5kbGVNZXNzYWdlID0gKG1zZzogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLmNoZWNrUHJvZ3Jlc3MobXNnKVxuICAgICAgdGhpcy5jaGVja1NldmVyaXR5Q2hhbmdlKG1zZylcbiAgICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMucGFyc2VNZXNzYWdlKG1zZylcbiAgICAgIGlmIChwYXJzZWQgJiYgdGhpcy5wYXJhbXMub25Nc2cpIHtcbiAgICAgICAgdGhpcy5wYXJhbXMub25Nc2cocGFyc2VkKVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdGU6IGJsb2NrQnVmZmVyZWQgdXNlZCB0d2ljZSBiZWNhdXNlIHdlIG5lZWQgc2VwYXJhdGUgYnVmZmVyc1xuICAgIC8vIGZvciBzdGRlcnIgYW5kIHN0ZG91dFxuICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgYmxvY2tCdWZmZXJlZChoYW5kbGVNZXNzYWdlKSlcbiAgICBwcm9jLnN0ZGVyci5vbignZGF0YScsIGJsb2NrQnVmZmVyZWQoaGFuZGxlTWVzc2FnZSkpXG5cbiAgICBwcm9jLm9uKCdjbG9zZScsIChleGl0Q29kZSkgPT4ge1xuICAgICAgaWYgKHRoaXMucGFyYW1zLm9uRG9uZSkgeyB0aGlzLnBhcmFtcy5vbkRvbmUoeyBleGl0Q29kZSwgaGFzRXJyb3I6IHRoaXMuaGFzRXJyb3IgfSkgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHVuaW5kZW50TWVzc2FnZShsaW5lczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBtaW5JbmRlbnQgPSBNYXRoLm1pbiguLi4obGluZXMubWFwKChsaW5lKSA9PiB7XG4gICAgICBjb25zdCBtYXRjaCA9IGxpbmUubWF0Y2goL15cXHMqLylcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICByZXR1cm4gbWF0Y2hbMF0ubGVuZ3RoXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gMFxuICAgICAgfVxuICAgIH0pKSlcbiAgICByZXR1cm4gbGluZXMubWFwKChsaW5lKSA9PiBsaW5lLnNsaWNlKG1pbkluZGVudCkpLmpvaW4oJ1xcbicpXG4gIH1cblxuICBwcml2YXRlIHBhcnNlTWVzc2FnZShyYXc6IHN0cmluZykge1xuICAgIGlmIChyYXcudHJpbSgpICE9PSAnJykge1xuICAgICAgY29uc3QgbWF0Y2hMb2MgPSAvXiguKyk6KFxcZCspOihcXGQrKTooPzogKFxcdyspOik/WyBcXHRdKihcXFtbXlxcXV0rXFxdKT9bIFxcdF0qXFxuPyhbXl0qKS9cbiAgICAgIGNvbnN0IG1hdGNoZWQgPSByYXcudHJpbVJpZ2h0KCkubWF0Y2gobWF0Y2hMb2MpXG4gICAgICBpZiAobWF0Y2hlZCkge1xuICAgICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZVxuXG4gICAgICAgIGNvbnN0IFtmaWxlLCBsaW5lLCBjb2wsIHJhd1R5cCwgY29udGV4dCwgbXNnXSA9IG1hdGNoZWQuc2xpY2UoMSlcbiAgICAgICAgY29uc3QgdHlwID0gcmF3VHlwID8gcmF3VHlwLnRvTG93ZXJDYXNlKCkgOiAnZXJyb3InXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB1cmk6IHBhdGguaXNBYnNvbHV0ZShmaWxlKSA/IGZpbGUgOiB0aGlzLmN3ZC5nZXRGaWxlKGZpbGUpLmdldFBhdGgoKSxcbiAgICAgICAgICBwb3NpdGlvbjogbmV3IFBvaW50KHBhcnNlSW50KGxpbmUsIDEwKSAtIDEsIHBhcnNlSW50KGNvbCwgMTApIC0gMSksXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICB0ZXh0OiB0aGlzLnVuaW5kZW50TWVzc2FnZShtc2cuc3BsaXQoJ1xcbicpKSxcbiAgICAgICAgICAgIGhpZ2hsaWdodGVyOiAnaGludC5tZXNzYWdlLmhhc2tlbGwnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V2ZXJpdHk6IHR5cCxcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtZXNzYWdlOiByYXcsXG4gICAgICAgICAgc2V2ZXJpdHk6IHRoaXMucGFyYW1zLnNldmVyaXR5LFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tTZXZlcml0eUNoYW5nZShkYXRhOiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMucGFyYW1zLnNldmVyaXR5Q2hhbmdlUngpIHsgcmV0dXJuIH1cbiAgICBmb3IgKGNvbnN0IFtzZXYsIHJ4XSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSkge1xuICAgICAgaWYgKGRhdGEubWF0Y2gocngpKSB7XG4gICAgICAgIHRoaXMucGFyYW1zLnNldmVyaXR5ID0gc2V2XG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1Byb2dyZXNzKGRhdGE6IHN0cmluZykge1xuICAgIGNvbnN0IG1hdGNoID0gZGF0YS5tYXRjaCgvXFxbXFxzKihbXFxkXSspXFxzK29mXFxzKyhbXFxkXSspXFxzKlxcXS8pXG4gICAgaWYgKG1hdGNoKSB7XG4gICAgICBjb25zdCBwcm9ncmVzcyA9IG1hdGNoWzFdXG4gICAgICBjb25zdCB0b3RhbCA9IG1hdGNoWzJdXG4gICAgICB0aGlzLnBhcmFtcy5vblByb2dyZXNzICYmIHRoaXMucGFyYW1zLm9uUHJvZ3Jlc3MocGFyc2VJbnQocHJvZ3Jlc3MsIDEwKSAvIHBhcnNlSW50KHRvdGFsLCAxMCkpXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5DYWJhbFByb2Nlc3MoXG4gIGNvbW1hbmQ6IHN0cmluZywgYXJnczogc3RyaW5nW10sIG9wdGlvbnM6IGNoaWxkX3Byb2Nlc3MuU3Bhd25PcHRpb25zLCBwYXJzOiBJUGFyYW1zLFxuKSB7XG4gIGNvbnN0IG5ld1BhcnM6IElQYXJhbXMgPSB7IC4uLnBhcnMgfVxuICByZXR1cm4gbmV3IFByb21pc2U8eyBleGl0Q29kZTogbnVtYmVyLCBoYXNFcnJvcjogYm9vbGVhbiB9PigocmVzb2x2ZSkgPT4ge1xuICAgIG5ld1BhcnMub25Eb25lID0gcmVzb2x2ZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW51c2VkLWV4cHJlc3Npb25cbiAgICBuZXcgQ2FiYWxQcm9jZXNzKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMsIG5ld1BhcnMpXG4gIH0pXG59XG4iXX0=