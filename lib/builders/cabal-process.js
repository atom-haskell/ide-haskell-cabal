"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const process_1 = require("process");
const path = require("path");
const os_1 = require("os");
const atom_1 = require("atom");
class CabalProcess {
    constructor(command, args, options, params) {
        this.params = params;
        this.cwd = new atom_1.Directory(options.cwd || '.');
        this.hasError = false;
        const proc = child_process.spawn(command, args, options);
        const buffered = (handleOutput) => {
            let buffer = '';
            return (data) => {
                const output = data.toString('utf8');
                const [first, ...tail] = output.split(os_1.EOL);
                buffer += first;
                if (tail.length > 0) {
                    const lines = [buffer, ...tail.slice(0, -1)];
                    buffer = tail.slice(-1)[0];
                    handleOutput(lines);
                }
            };
        };
        const blockBuffered = (handleOutput) => {
            const startOfMessage = /\n(?=\S)/g;
            let buffer = [];
            proc.on('close', () => handleOutput(buffer.join('\n')));
            return buffered((lines) => {
                buffer.push(...lines);
                const [first, ...tail] = buffer.join('\n').split(startOfMessage);
                if (tail.length > 0) {
                    const last = tail.slice(-1)[0];
                    buffer = last.split('\n');
                    for (const block of [first, ...tail.slice(0, -1)]) {
                        handleOutput(block);
                    }
                }
            });
        };
        if (this.params.setCancelAction) {
            this.params.setCancelAction(() => {
                try {
                    process_1.kill(-proc.pid);
                }
                catch (e) {
                }
                try {
                    process_1.kill(proc.pid);
                }
                catch (e) {
                }
                try {
                    proc.kill();
                }
                catch (e) {
                }
            });
        }
        const handleMessage = (msg) => {
            this.checkProgress(msg);
            this.checkSeverityChange(msg);
            const parsed = this.parseMessage(msg);
            if (parsed && this.params.onMsg) {
                this.params.onMsg(parsed);
            }
        };
        proc.stdout.on('data', blockBuffered(handleMessage));
        proc.stderr.on('data', blockBuffered(handleMessage));
        proc.on('close', (exitCode) => {
            if (this.params.onDone) {
                this.params.onDone({ exitCode, hasError: this.hasError });
            }
        });
    }
    unindentMessage(lines) {
        const minIndent = Math.min(...lines.map((line) => {
            const match = line.match(/^\s*/);
            if (match) {
                return match[0].length;
            }
            else {
                return 0;
            }
        }));
        return lines.map((line) => line.slice(minIndent)).join('\n');
    }
    parseMessage(raw) {
        if (raw.trim() !== '') {
            const matchLoc = /^(.+):(\d+):(\d+):(?: (\w+):)?[ \t]*(\[[^\]]+\])?[ \t]*\n?([^]*)/;
            const matched = raw.trimRight().match(matchLoc);
            if (matched) {
                this.hasError = true;
                const [file, line, col, rawTyp, context, msg] = matched.slice(1);
                const typ = rawTyp ? rawTyp.toLowerCase() : 'error';
                return {
                    uri: path.isAbsolute(file) ? file : this.cwd.getFile(file).getPath(),
                    position: new atom_1.Point(parseInt(line, 10) - 1, parseInt(col, 10) - 1),
                    context,
                    message: {
                        text: this.unindentMessage(msg.split('\n')),
                        highlighter: 'hint.message.haskell',
                    },
                    severity: typ,
                };
            }
            else {
                return {
                    message: raw,
                    severity: this.params.severity,
                };
            }
        }
        return undefined;
    }
    checkSeverityChange(data) {
        if (!this.params.severityChangeRx) {
            return;
        }
        for (const [sev, rx] of Object.entries(this.params.severityChangeRx)) {
            if (data.match(rx)) {
                this.params.severity = sev;
                break;
            }
        }
    }
    checkProgress(data) {
        const match = data.match(/\[\s*([\d]+)\s+of\s+([\d]+)\s*\]/);
        if (match) {
            const progress = match[1];
            const total = match[2];
            this.params.onProgress &&
                this.params.onProgress(parseInt(progress, 10) / parseInt(total, 10));
        }
    }
}
async function runCabalProcess(command, args, options, pars) {
    const newPars = Object.assign({}, pars);
    return new Promise((resolve) => {
        newPars.onDone = resolve;
        new CabalProcess(command, args, options, newPars);
    });
}
exports.runCabalProcess = runCabalProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FiYWwtcHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWlsZGVycy9jYWJhbC1wcm9jZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0NBQThDO0FBQzlDLHFDQUE4QjtBQUM5Qiw2QkFBNEI7QUFDNUIsMkJBQXdCO0FBSXhCLCtCQUF1QztBQVd2QztJQUlFLFlBQ0UsT0FBZSxFQUNmLElBQWMsRUFDZCxPQUFtQyxFQUMzQixNQUFlO1FBQWYsV0FBTSxHQUFOLE1BQU0sQ0FBUztRQUV2QixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksZ0JBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFBO1FBTTVDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFBO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUV4RCxNQUFNLFFBQVEsR0FBRyxDQUFDLFlBQXVDLEVBQUUsRUFBRTtZQUMzRCxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUE7WUFDZixNQUFNLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtnQkFDdEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFDcEMsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBRyxDQUFDLENBQUE7Z0JBRzFDLE1BQU0sSUFBSSxLQUFLLENBQUE7Z0JBQ2YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUVwQixNQUFNLEtBQUssR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFDNUMs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QUFDO0lBQ0gsQ0FBQztDQUNGO0FBRU0sS0FBSywwQkFDVixPQUFlLEVBQ2YsSUFBYyxFQUNkLE9BQW1DLEVBQ25DLElBQWE7SUFFYixNQUFNLE9BQU8scUJBQWlCLElBQUksQ0FBRSxDQUFBO0lBQ3BDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBMEMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUN0RSxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQTtRQUV4QixJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUNuRCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFaRCwwQ0FZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IGtpbGwgfSBmcm9tICdwcm9jZXNzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcblxuLy8gLy8gQXRvbSBkZXBlbmRlbmNpZXNcbmltcG9ydCB7IERpcmVjdG9yeSwgUG9pbnQgfSBmcm9tICdhdG9tJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbXMge1xuICBvbk1zZz86IChtc2c6IFVQSS5JUmVzdWx0SXRlbSkgPT4gdm9pZFxuICBvblByb2dyZXNzPzogKHByb2dyZXNzOiBudW1iZXIpID0+IHZvaWRcbiAgb25Eb25lPzogKGRvbmU6IHsgZXhpdENvZGU6IG51bWJlcjsgaGFzRXJyb3I6IGJvb2xlYW4gfSkgPT4gdm9pZFxuICBzZXRDYW5jZWxBY3Rpb24/OiAoYWN0aW9uOiAoKSA9PiB2b2lkKSA9PiB2b2lkXG4gIHNldmVyaXR5OiBVUEkuVFNldmVyaXR5XG4gIHNldmVyaXR5Q2hhbmdlUng/OiB7IFtLIGluIFVQSS5UU2V2ZXJpdHldOiBSZWdFeHAgfVxufVxuXG5jbGFzcyBDYWJhbFByb2Nlc3Mge1xuICBwcml2YXRlIGN3ZDogRGlyZWN0b3J5XG4gIHByaXZhdGUgaGFzRXJyb3I6IGJvb2xlYW5cblxuICBjb25zdHJ1Y3RvcihcbiAgICBjb21tYW5kOiBzdHJpbmcsXG4gICAgYXJnczogc3RyaW5nW10sXG4gICAgb3B0aW9uczogY2hpbGRfcHJvY2Vzcy5TcGF3bk9wdGlvbnMsXG4gICAgcHJpdmF0ZSBwYXJhbXM6IElQYXJhbXMsXG4gICkge1xuICAgIHRoaXMuY3dkID0gbmV3IERpcmVjdG9yeShvcHRpb25zLmN3ZCB8fCAnLicpXG4gICAgLy8gY2FiYWwgcmV0dXJucyBmYWlsdXJlIHdoZW4gdGhlcmUgYXJlIHR5cGUgZXJyb3JzIF9vcl8gd2hlbiBpdCBjYW4ndFxuICAgIC8vIGNvbXBpbGUgdGhlIGNvZGUgYXQgYWxsIChpLmUuLCB3aGVuIHRoZXJlIGFyZSBtaXNzaW5nIGRlcGVuZGVuY2llcykuXG4gICAgLy8gU2luY2UgaXQncyBoYXJkIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gdGhlc2UgdHdvLCB3ZSBsb29rIGF0IHRoZVxuICAgIC8vIHBhcnNlZCBlcnJvcnM7XG4gICAgLy8gdGhpcy5oYXNFcnJvciBpcyBzZXQgaWYgd2UgZmluZCBhbiBlcnJvci93YXJuaW5nLCBzZWUgcGFyc2VNZXNzYWdlXG4gICAgdGhpcy5oYXNFcnJvciA9IGZhbHNlXG4gICAgY29uc3QgcHJvYyA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oY29tbWFuZCwgYXJncywgb3B0aW9ucylcblxuICAgIGNvbnN0IGJ1ZmZlcmVkID0gKGhhbmRsZU91dHB1dDogKGxpbmVzOiBzdHJpbmdbXSkgPT4gdm9pZCkgPT4ge1xuICAgICAgbGV0IGJ1ZmZlciA9ICcnXG4gICAgICByZXR1cm4gKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICAgICAgICBjb25zdCBvdXRwdXQgPSBkYXRhLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgICAgY29uc3QgW2ZpcnN0LCAuLi50YWlsXSA9IG91dHB1dC5zcGxpdChFT0wpXG4gICAgICAgIC8vIF4gVGhlIG9ubHkgcGxhY2Ugd2hlcmUgd2UgZ2V0IG9zLXNwZWNpZmljIEVPTCAoQ1IvQ1JMRi9MRilcbiAgICAgICAgLy8gaW4gdGhlIHJlc3Qgb2YgdGhlIGNvZGUgd2UncmUgdXNpbmcganVzdCBMRiAoXFxuKVxuICAgICAgICBidWZmZXIgKz0gZmlyc3RcbiAgICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkge1xuICAgICAgICAgIC8vIGl0IG1lYW5zIHRoZXJlJ3MgYXQgbGVhc3Qgb25lIG5ld2xpbmVcbiAgICAgICAgICBjb25zdCBsaW5lcyA9IFtidWZmZXIsIC4uLnRhaWwuc2xpY2UoMCwgLTEpXVxuICAgICAgICAgIGJ1ZmZlciA9IHRhaWwuc2xpY2UoLTEpWzBdXG4gICAgICAgICAgaGFuZGxlT3V0cHV0KGxpbmVzKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYmxvY2tCdWZmZXJlZCA9IChoYW5kbGVPdXRwdXQ6IChibG9jazogc3RyaW5nKSA9PiB2b2lkKSA9PiB7XG4gICAgICAvLyBTdGFydCBvZiBhIENhYmFsIG1lc3NhZ2VcbiAgICAgIGNvbnN0IHN0YXJ0T2ZNZXNzYWdlID0gL1xcbig/PVxcUykvZ1xuICAgICAgbGV0IGJ1ZmZlcjogc3RyaW5nW10gPSBbXVxuICAgICAgcHJvYy5vbignY2xvc2UnLCAoKSA9PiBoYW5kbGVPdXRwdXQoYnVmZmVyLmpvaW4oJ1xcbicpKSlcbiAgICAgIHJldHVybiBidWZmZXJlZCgobGluZXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIGJ1ZmZlci5wdXNoKC4uLmxpbmVzKVxuICAgICAgICAvLyBDb3VsZCBpdGVyYXRlIG92ZXIgbGluZXMgaGVyZSwgYnV0IHRoaXMgaXMgZWFzaWVyLCBpZiBub3QgYXMgZWZmZWN0aXZlXG4gICAgICAgIGNvbnN0IFtmaXJzdCwgLi4udGFpbF0gPSBidWZmZXIuam9pbignXFxuJykuc3BsaXQoc3RhcnRPZk1lc3NhZ2UpXG4gICAgICAgIGlmICh0YWlsLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBsYXN0ID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgICBidWZmZXIgPSBsYXN0LnNwbGl0KCdcXG4nKVxuICAgICAgICAgIGZvciAoY29uc3QgYmxvY2sgb2YgW2ZpcnN0LCAuLi50YWlsLnNsaWNlKDAsIC0xKV0pIHtcbiAgICAgICAgICAgIGhhbmRsZU91dHB1dChibG9jaylcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYgKHRoaXMucGFyYW1zLnNldENhbmNlbEFjdGlvbikge1xuICAgICAgdGhpcy5wYXJhbXMuc2V0Q2FuY2VsQWN0aW9uKCgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBraWxsKC1wcm9jLnBpZClcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIC8qbm9vcCovXG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBraWxsKHByb2MucGlkKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgLypub29wKi9cbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIHByb2Mua2lsbCgpXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAvKm5vb3AqL1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGhhbmRsZU1lc3NhZ2UgPSAobXNnOiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuY2hlY2tQcm9ncmVzcyhtc2cpXG4gICAgICB0aGlzLmNoZWNrU2V2ZXJpdHlDaGFuZ2UobXNnKVxuICAgICAgY29uc3QgcGFyc2VkID0gdGhpcy5wYXJzZU1lc3NhZ2UobXNnKVxuICAgICAgaWYgKHBhcnNlZCAmJiB0aGlzLnBhcmFtcy5vbk1zZykge1xuICAgICAgICB0aGlzLnBhcmFtcy5vbk1zZyhwYXJzZWQpXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTm90ZTogYmxvY2tCdWZmZXJlZCB1c2VkIHR3aWNlIGJlY2F1c2Ugd2UgbmVlZCBzZXBhcmF0ZSBidWZmZXJzXG4gICAgLy8gZm9yIHN0ZGVyciBhbmQgc3Rkb3V0XG4gICAgcHJvYy5zdGRvdXQub24oJ2RhdGEnLCBibG9ja0J1ZmZlcmVkKGhhbmRsZU1lc3NhZ2UpKVxuICAgIHByb2Muc3RkZXJyLm9uKCdkYXRhJywgYmxvY2tCdWZmZXJlZChoYW5kbGVNZXNzYWdlKSlcblxuICAgIHByb2Mub24oJ2Nsb3NlJywgKGV4aXRDb2RlKSA9PiB7XG4gICAgICBpZiAodGhpcy5wYXJhbXMub25Eb25lKSB7XG4gICAgICAgIHRoaXMucGFyYW1zLm9uRG9uZSh7IGV4aXRDb2RlLCBoYXNFcnJvcjogdGhpcy5oYXNFcnJvciB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHVuaW5kZW50TWVzc2FnZShsaW5lczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBtaW5JbmRlbnQgPSBNYXRoLm1pbihcbiAgICAgIC4uLmxpbmVzLm1hcCgobGluZSkgPT4ge1xuICAgICAgICBjb25zdCBtYXRjaCA9IGxpbmUubWF0Y2goL15cXHMqLylcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgcmV0dXJuIG1hdGNoWzBdLmxlbmd0aFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiAwXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgIClcbiAgICByZXR1cm4gbGluZXMubWFwKChsaW5lKSA9PiBsaW5lLnNsaWNlKG1pbkluZGVudCkpLmpvaW4oJ1xcbicpXG4gIH1cblxuICBwcml2YXRlIHBhcnNlTWVzc2FnZShyYXc6IHN0cmluZykge1xuICAgIGlmIChyYXcudHJpbSgpICE9PSAnJykge1xuICAgICAgY29uc3QgbWF0Y2hMb2MgPSAvXiguKyk6KFxcZCspOihcXGQrKTooPzogKFxcdyspOik/WyBcXHRdKihcXFtbXlxcXV0rXFxdKT9bIFxcdF0qXFxuPyhbXl0qKS9cbiAgICAgIGNvbnN0IG1hdGNoZWQgPSByYXcudHJpbVJpZ2h0KCkubWF0Y2gobWF0Y2hMb2MpXG4gICAgICBpZiAobWF0Y2hlZCkge1xuICAgICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZVxuXG4gICAgICAgIGNvbnN0IFtmaWxlLCBsaW5lLCBjb2wsIHJhd1R5cCwgY29udGV4dCwgbXNnXSA9IG1hdGNoZWQuc2xpY2UoMSlcbiAgICAgICAgY29uc3QgdHlwID0gcmF3VHlwID8gcmF3VHlwLnRvTG93ZXJDYXNlKCkgOiAnZXJyb3InXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB1cmk6IHBhdGguaXNBYnNvbHV0ZShmaWxlKSA/IGZpbGUgOiB0aGlzLmN3ZC5nZXRGaWxlKGZpbGUpLmdldFBhdGgoKSxcbiAgICAgICAgICBwb3NpdGlvbjogbmV3IFBvaW50KHBhcnNlSW50KGxpbmUsIDEwKSAtIDEsIHBhcnNlSW50KGNvbCwgMTApIC0gMSksXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICB0ZXh0OiB0aGlzLnVuaW5kZW50TWVzc2FnZShtc2cuc3BsaXQoJ1xcbicpKSxcbiAgICAgICAgICAgIGhpZ2hsaWdodGVyOiAnaGludC5tZXNzYWdlLmhhc2tlbGwnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V2ZXJpdHk6IHR5cCxcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtZXNzYWdlOiByYXcsXG4gICAgICAgICAgc2V2ZXJpdHk6IHRoaXMucGFyYW1zLnNldmVyaXR5LFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tTZXZlcml0eUNoYW5nZShkYXRhOiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMucGFyYW1zLnNldmVyaXR5Q2hhbmdlUngpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtzZXYsIHJ4XSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnBhcmFtcy5zZXZlcml0eUNoYW5nZVJ4KSkge1xuICAgICAgaWYgKGRhdGEubWF0Y2gocngpKSB7XG4gICAgICAgIHRoaXMucGFyYW1zLnNldmVyaXR5ID0gc2V2XG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1Byb2dyZXNzKGRhdGE6IHN0cmluZykge1xuICAgIGNvbnN0IG1hdGNoID0gZGF0YS5tYXRjaCgvXFxbXFxzKihbXFxkXSspXFxzK29mXFxzKyhbXFxkXSspXFxzKlxcXS8pXG4gICAgaWYgKG1hdGNoKSB7XG4gICAgICBjb25zdCBwcm9ncmVzcyA9IG1hdGNoWzFdXG4gICAgICBjb25zdCB0b3RhbCA9IG1hdGNoWzJdXG4gICAgICB0aGlzLnBhcmFtcy5vblByb2dyZXNzICYmXG4gICAgICAgIHRoaXMucGFyYW1zLm9uUHJvZ3Jlc3MocGFyc2VJbnQocHJvZ3Jlc3MsIDEwKSAvIHBhcnNlSW50KHRvdGFsLCAxMCkpXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5DYWJhbFByb2Nlc3MoXG4gIGNvbW1hbmQ6IHN0cmluZyxcbiAgYXJnczogc3RyaW5nW10sXG4gIG9wdGlvbnM6IGNoaWxkX3Byb2Nlc3MuU3Bhd25PcHRpb25zLFxuICBwYXJzOiBJUGFyYW1zLFxuKSB7XG4gIGNvbnN0IG5ld1BhcnM6IElQYXJhbXMgPSB7IC4uLnBhcnMgfVxuICByZXR1cm4gbmV3IFByb21pc2U8eyBleGl0Q29kZTogbnVtYmVyOyBoYXNFcnJvcjogYm9vbGVhbiB9PigocmVzb2x2ZSkgPT4ge1xuICAgIG5ld1BhcnMub25Eb25lID0gcmVzb2x2ZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW51c2VkLWV4cHJlc3Npb25cbiAgICBuZXcgQ2FiYWxQcm9jZXNzKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMsIG5ld1BhcnMpXG4gIH0pXG59XG4iXX0=